<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>External Repository Server Bootstrap &mdash; Koji alpha documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Koji Kerberos/GSSAPI debugging" href="kerberos_gssapi_debug.html" />
    <link rel="prev" title="Storage Volumes" href="volumes.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Koji
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Operations Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="server_howto.html">Server Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="server_bootstrap.html">Koji Server Bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="volumes.html">Storage Volumes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">External Repository Server Bootstrap</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bootstrapping-a-new-external-repo-koji-build-environment">Bootstrapping a new External Repo Koji build environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#regenerating-your-repo">Regenerating your repo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples-of-urls-to-use-for-external-repositories">Examples of urls to use for external Repositories</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fedora-35">Fedora 35</a></li>
<li class="toctree-l4"><a class="reference internal" href="#centos-8-and-epel">CentOS 8 and EPEL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-tags-and-targets">Example tags and targets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tags">Tags</a></li>
<li class="toctree-l4"><a class="reference internal" href="#targets">Targets</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kerberos_gssapi_debug.html">Koji Kerberos/GSSAPI debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="kojid_conf.html">Builder Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="hub_conf.html">Hub Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="database_howto.html">Database Performance Howto</a></li>
<li class="toctree-l2"><a class="reference internal" href="image_build.html">Building Images in Koji</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html">Koji Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">Tasks Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="containers.html">Running Koji in Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="supported_platforms.html">Supported Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases.html">Releases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Administration%20Guide/index.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../User%20Guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developer%20Guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../runs_here.html">Runs Here</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Koji</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Operations Guide</a> &raquo;</li>
      <li>External Repository Server Bootstrap</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Operations Guide/external_repo_server_bootstrap.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="external-repository-server-bootstrap">
<h1>External Repository Server Bootstrap<a class="headerlink" href="#external-repository-server-bootstrap" title="Permalink to this headline"></a></h1>
<div class="section" id="bootstrapping-a-new-external-repo-koji-build-environment">
<h2>Bootstrapping a new External Repo Koji build environment<a class="headerlink" href="#bootstrapping-a-new-external-repo-koji-build-environment" title="Permalink to this headline"></a></h2>
<p>These are the steps involved in pointing a new Koji server at external
repositories so that it can be used for building. This assumes that the Koji
hub is up, appropriate authentication methods have been configured, the Koji
repo administration daemon (<code class="docutils literal notranslate"><span class="pre">kojira</span></code>) is properly configured and running,
and at least one Koji builder (<code class="docutils literal notranslate"><span class="pre">kojid</span></code>) is properly configured and running.
All koji cli commands assume that the user is a Koji <code class="docutils literal notranslate"><span class="pre">admin</span></code>.  If you need
help with these tasks, see the <a class="reference internal" href="server_howto.html"><span class="doc">Server Installation</span></a>.</p>
<ul>
<li><p>Create a new tag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji add-tag dist-foo
</pre></div>
</div>
</li>
<li><p>Create a build tag with the desired arches, and the previously created tag
as a parent.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji add-tag --parent dist-foo --arches <span class="s2">&quot;i386 x86_64 ppc ppc64&quot;</span> dist-foo-build
</pre></div>
</div>
</li>
<li><p>Add an external repository to your build tag. Koji substitutes $arch for the
arches in your build tag. The <code class="docutils literal notranslate"><span class="pre">$</span></code> needs to be escaped for the shell to send
it though without interpreting it. See below for some additional examples of
external repo URLs.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji add-external-repo -t dist-foo-build dist-foo-external-repo http://repo-server.example.com/path/to/repo/for/foo/<span class="se">\$</span>arch/
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are adding multiple external repos, koji assigns a priority to each
repo in FIFO order. This may cause updated packages to not be visible if a
repo with older packages is ranked at a higher priority (lower numeric
value). Use the <code class="docutils literal notranslate"><span class="pre">-p</span></code> flag to set specific repo priorities.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This uses $arch NOT $basearch</p>
</div>
<p>Koji behaves differently to the external repository based on which <code class="docutils literal notranslate"><span class="pre">merge</span></code>
mode is set for that. Merge modes can be set via <code class="docutils literal notranslate"><span class="pre">-m</span></code> option and are as
follows:</p>
<blockquote>
<div><dl>
<dt><code class="docutils literal notranslate"><span class="pre">koji</span></code></dt><dd><p>Basic mode - koji expects, that that repo is complete and
doesn’t contain mixed content. It means that only rpms from one SRPM can
be present in repo for given package.</p>
<p>It runs <code class="docutils literal notranslate"><span class="pre">mergerepos_c</span> <span class="pre">--koji</span></code> Repositories generated via <code class="docutils literal notranslate"><span class="pre">dist-repo</span></code>
command (and all other repositories coming from koji` has these
properties.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bare</span></code></dt><dd><p>It runs <code class="docutils literal notranslate"><span class="pre">mergerepos_c</span> <span class="pre">--pkgorigins</span> <span class="pre">--all</span></code>. It includes all rpms with
same package name and architecture even if version or release is
different. This one is needed for modular repos. <code class="docutils literal notranslate"><span class="pre">createrepo_c</span></code> 0.14+
compiled with <code class="docutils literal notranslate"><span class="pre">libmodule</span></code> support needs to be installed on the
builder. Nevertheless, only the first rpm with identical NEVRA is
accepted.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">simple</span></code></dt><dd><p>It runs <code class="docutils literal notranslate"><span class="pre">mergerepos_c</span> <span class="pre">--mode</span> <span class="pre">simple</span></code> - we’re least restrivtive with
this type of repo. Even packages with identical NEVRA are accepted in
such case. Simple mode is in <code class="docutils literal notranslate"><span class="pre">createrepo_c</span></code> suite from version 0.13.
Reasons to use this compared to <code class="docutils literal notranslate"><span class="pre">bare</span></code> mode is a) you have older
<code class="docutils literal notranslate"><span class="pre">createrepo_c</span></code>, b) you really want to have all this identical NEVRAs
in the repo.</p>
</dd>
</dl>
</div></blockquote>
</li>
<li><p>Create a build target that includes the tags you’ve already created.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji add-target dist-foo dist-foo-build
</pre></div>
</div>
<p>At this point you can verify that your external repository is set with the
“taginfo” command. You should see it listed under “External repos”. Here is
an example with several CentOS external repos:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji taginfo dist-foo-build
<span class="go">  Tag: dist-foo-build [740]</span>
<span class="go">  Arches: x86_64</span>
<span class="go">  Groups: build, srpm-build</span>
<span class="go">  Tag options:</span>
<span class="go">  This tag is a buildroot for one or more targets</span>
<span class="go">  Current repo: repo#55077: 2017-11-29 03:34:18.847127</span>
<span class="go">  Targets that build from this tag:</span>
<span class="go">    dist-foo</span>
<span class="go">  External repos:</span>
<span class="go">      2 centos7-cr (http://mirror.centos.org/centos/7/cr/$arch/)</span>
<span class="go">      3 centos7-extras (http://mirror.centos.org/centos/7/extras/$arch/)</span>
<span class="go">      5 centos7-updates (http://mirror.centos.org/centos/7/updates/$arch/)</span>
<span class="go">     10 centos7-os (http://mirror.centos.org/centos/7/os/$arch/)</span>
</pre></div>
</div>
</li>
<li><p>Create a ‘’build’’ and ‘’srpm-build’’ group associated with your build tag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji add-group dist-foo-build build
<span class="gp">$ </span>koji add-group dist-foo-build srpm-build
</pre></div>
</div>
</li>
<li><p>Populate the <code class="docutils literal notranslate"><span class="pre">build</span></code> and <code class="docutils literal notranslate"><span class="pre">srpm-build</span></code> group with packages that will be
installed into the minimal buildroot. You can find out what the is in the
current groups for Fedora by running <code class="docutils literal notranslate"><span class="pre">koji</span> <span class="pre">list-groups</span> <span class="pre">dist-f9-build</span></code>
against the Fedora Koji instance. This is probably a good starting point for
your minimal buildroot and srpm creation buildroot. If you are rebuilding
Fedora packages, it is recommended that you add all packages listed in the
Fedora Koji instance.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji add-group-pkg dist-foo-build build &lt;pkg1&gt; &lt;pkg2&gt; .....
</pre></div>
</div>
</li>
<li><p>Add packages that you intend to build to your tag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji add-pkg --owner &lt;kojiuser&gt; dist-foo &lt;pkg1&gt; &lt;pkg2&gt; .....
</pre></div>
</div>
</li>
<li><p>Wait for the repo to regenerate, and you should now be able to run a build
successfully.</p></li>
</ul>
</div>
<div class="section" id="regenerating-your-repo">
<h2>Regenerating your repo<a class="headerlink" href="#regenerating-your-repo" title="Permalink to this headline"></a></h2>
<p>koji doesn’t monitor external repositories for changes by default.
Administrators can enable such bejaviour with setting <code class="docutils literal notranslate"><span class="pre">check_external_repos</span> <span class="pre">=</span>
<span class="pre">true</span></code> in <code class="docutils literal notranslate"><span class="pre">kojira.conf</span></code> (for details see <a class="reference internal" href="utils.html"><span class="doc">Koji Utilities</span></a>). If it is not
enabled new repositories will be generated when packages you build land in a tag
that populates the buildroot or you manually regenerate the repository. you
should be sure to regularly regenerate the repositories manually to pick up
updates.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji regen-repo dist-foo-build
</pre></div>
</div>
</div>
<div class="section" id="examples-of-urls-to-use-for-external-repositories">
<h2>Examples of urls to use for external Repositories<a class="headerlink" href="#examples-of-urls-to-use-for-external-repositories" title="Permalink to this headline"></a></h2>
<p>all these examples use mirrors.kernel.org please find the closest mirror
to yourself. Note that the Fedora minimal buildroots download ~100Mb
then build dependencies on top. these are downloaded each build you can
save a lot of network bandwidth by using a local mirror or running
through a caching proxy.</p>
<p>NOTE: this uses $arch <strong>NOT</strong> $basearch</p>
<div class="section" id="fedora-35">
<h3>Fedora 35<a class="headerlink" href="#fedora-35" title="Permalink to this headline"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>https://download.fedoraproject.org/pub/linux/fedora/linux/releases/35/Everything/\$arch/os/
https://download.fedoraproject.org/pub/linux/fedora/linux/updates/35/Everything/\$arch/
</pre></div>
</div>
</div>
<div class="section" id="centos-8-and-epel">
<h3>CentOS 8 and EPEL<a class="headerlink" href="#centos-8-and-epel" title="Permalink to this headline"></a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>http://mirror.centos.org/centos/7/os/\$arch/
http://mirror.centos.org/centos/7/updates/\$arch/
https://dl.fedoraproject.org/pub/epel/7/\$arch/
</pre></div>
</div>
</div>
</div>
<div class="section" id="example-tags-and-targets">
<h2>Example tags and targets<a class="headerlink" href="#example-tags-and-targets" title="Permalink to this headline"></a></h2>
<p>In the simplest setup, where you just want to build against what is
available in the external repositories, you may want to go with a simple
layout of <em>dist-f**X*</em>-build* tags inheriting one another, and
<em>dist-f**X*</em>-updates* tags and targets that inherit the
<em>dist-f**X*</em>-build* tag and have external repos attached to them. This
way, a <em>dist-f**Y*</em>-build* or <em>dist-f**Y*</em>-updates* tag will not
automatically inherit the external repos of your <em>dist-f**X**</em> tags.</p>
<div class="section" id="tags">
<h3>Tags<a class="headerlink" href="#tags" title="Permalink to this headline"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dist-f10-updates               - This is where the external repos for f10 release and f10 updates are attached</span>
<span class="go"> `- dist-f10-build             - This is the f10 build target with the &#39;build&#39; and &#39;srpm-build&#39; group inherited from dist-f9-build,</span>
<span class="go">     |                           so that your buildroot gets populated but you do not have to maintain these groups for each</span>
<span class="go">     |                           separate release.</span>
<span class="go">     `- dist-f9-build          - etc.</span>
<span class="go">         `- dist-f8-build      - etc.</span>
</pre></div>
</div>
</div>
<div class="section" id="targets">
<h3>Targets<a class="headerlink" href="#targets" title="Permalink to this headline"></a></h3>
<p>Each <em>dist-f**X*</em>-build* tag has a <em>dist-f**X*</em>-updates* child tag,
and each <em>dist-f**X*</em>-updates* tag has a corresponding
<em>dist-f**X*</em>-updates-candidate* build target.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="volumes.html" class="btn btn-neutral float-left" title="Storage Volumes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="kerberos_gssapi_debug.html" class="btn btn-neutral float-right" title="Koji Kerberos/GSSAPI debugging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Mike McLean, Mike B, Dennis Gilmore, Mathieu Bridon, Ian McLeod, Ralph Bean, Adam Miller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>