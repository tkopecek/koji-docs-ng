<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Koji Miscellaneous Notes &mdash; Koji alpha documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Runs Here" href="runs_here.html" />
    <link rel="prev" title="Koji HOWTO" href="HOWTO.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Koji
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Operations%20Guide/index.html">Operations Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Administration%20Guide/index.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="User%20Guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Developer%20Guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="HOWTO.html">Koji HOWTO</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Koji Miscellaneous Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#notes-and-miscellaneous-details-about-koji">Notes and miscellaneous details about Koji</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#koji-cli">Koji CLI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#getting-help">Getting Help</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-from-srpm">Building from SRPM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-from-scm">Building from SCM</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#koji-tasks">Koji tasks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#buildnotifications">BuildNotifications</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#koji-server-administration">Koji server administration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#importing-an-rpm-without-srpm">Importing an rpm without srpm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multi-arch-builds">Multi-arch builds</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-noarch-sub-packages-are-built">How noarch sub-packages are built</a></li>
<li class="toctree-l4"><a class="reference internal" href="#manually-submitting-a-task">Manually submitting a task</a></li>
<li class="toctree-l4"><a class="reference internal" href="#managing-your-tags">Managing your tags</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#spec-file-processing">Spec file processing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#macro-processing">Macro processing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="runs_here.html">Runs Here</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Koji</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Koji Miscellaneous Notes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/misc.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="koji-miscellaneous-notes">
<h1>Koji Miscellaneous Notes<a class="headerlink" href="#koji-miscellaneous-notes" title="Permalink to this headline"></a></h1>
<div class="section" id="notes-and-miscellaneous-details-about-koji">
<h2>Notes and miscellaneous details about Koji<a class="headerlink" href="#notes-and-miscellaneous-details-about-koji" title="Permalink to this headline"></a></h2>
<p>This document is intended to illuminate some of the small quirks that
you may encounter while running your own koji server.</p>
<div class="section" id="koji-cli">
<h3>Koji CLI<a class="headerlink" href="#koji-cli" title="Permalink to this headline"></a></h3>
<div class="section" id="getting-help">
<h4>Getting Help<a class="headerlink" href="#getting-help" title="Permalink to this headline"></a></h4>
<ul>
<li><p>There are multiple ways to receive help from the koji command, each
of them gives you something a little different:</p>
<ul>
<li><p>List of user commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">koji</span> <span class="n">help</span>
</pre></div>
</div>
</li>
<li><p>Command-specific help:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">koji</span> <span class="p">[</span><span class="n">command</span><span class="p">]</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
</li>
<li><p>List of admin commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">koji</span> <span class="n">help</span> <span class="o">--</span><span class="n">admin</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="building-from-srpm">
<h4>Building from SRPM<a class="headerlink" href="#building-from-srpm" title="Permalink to this headline"></a></h4>
<p>Koji only allows admins access to build directly from srpm. It expects
normal users to build out of an SCM.</p>
</div>
<div class="section" id="building-from-scm">
<h4>Building from SCM<a class="headerlink" href="#building-from-scm" title="Permalink to this headline"></a></h4>
<div class="section" id="scm-layout">
<h5>SCM Layout<a class="headerlink" href="#scm-layout" title="Permalink to this headline"></a></h5>
<p>When building out of an SCM, Koji expects there will be a Makefile in
the project root that has a ‘sources’ target. Koji will call ‘make
sources’ on the checked out files.</p>
<p>This target simply needs to download all the sources for the SRPM that
are not already included in the SCM repository.</p>
</div>
<div class="section" id="scm-uri-structure">
<h5>SCM URI Structure<a class="headerlink" href="#scm-uri-structure" title="Permalink to this headline"></a></h5>
<p>In Fedora, this detail is typically handled by the fedpkg tool. Outside
of Fedora, you may need to know how to manually submit builds from an
SCM to koji.</p>
<p>Koji accepts an SCM URI in this format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>koji build [target] [scheme]://[user]@[hostname]/[path/to/repository]?[path/to/project]#[revision]
</pre></div>
</div>
<p>Note the division between repository path and project path. During setup
of kojid, the allowed_scms parameter is configured in
/etc/kojid/kojid.conf. This value of this parameter should match the
path to the repository.</p>
<p>In some SCM configurations, there isn’t a difference between repository
path and project path. In these cases, it should be understood that
dividing your SCM path into two components, URI path and URI query, can
seem somewhat arbitrary. An easy way to remember this detail is that the
path specified in allowed_scms is the portion of your SCM path that
goes before the URI query, any sub-directories not specified in
allowed_scms is given to koji as the URI query.</p>
</div>
</div>
</div>
<div class="section" id="koji-tasks">
<h3>Koji tasks<a class="headerlink" href="#koji-tasks" title="Permalink to this headline"></a></h3>
<div class="section" id="buildnotifications">
<h4>BuildNotifications<a class="headerlink" href="#buildnotifications" title="Permalink to this headline"></a></h4>
<ul class="simple">
<li><p>Koji sends build notifications to the package owner and the user who
submitted the build. For BuildNotifications to work successfully, the
package owner’s username needs to match a valid username for an
e-mail address, because kojihub sends to
<a class="reference external" href="mailto:username&#37;&#52;&#48;domain_in_kojihub&#46;conf">username<span>&#64;</span>domain_in_kojihub<span>&#46;</span>conf</a>.</p>
<ul>
<li><p>For SSL authentication, this means that your CN must be valid as
the user portion of an e-mail address.</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="koji-server-administration">
<h3>Koji server administration<a class="headerlink" href="#koji-server-administration" title="Permalink to this headline"></a></h3>
<div class="section" id="importing-an-rpm-without-srpm">
<h4>Importing an rpm without srpm<a class="headerlink" href="#importing-an-rpm-without-srpm" title="Permalink to this headline"></a></h4>
<p>If you are running a private koji instance, you may run into a situation
where you need to integrate a proprietary rpm into your build system. To
do this, it is similar to the package imports you did when bootstrapping
your koji instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">koji</span> <span class="kn">import</span> <span class="o">--</span><span class="n">create</span><span class="o">-</span><span class="n">build</span> <span class="p">[</span><span class="n">package</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="multi-arch-builds">
<h4>Multi-arch builds<a class="headerlink" href="#multi-arch-builds" title="Permalink to this headline"></a></h4>
<p>There are some packages that need to build across multiple arches. For
example, the kernel package no longer builds an i386 kernel, kernels are
built on i586 and above. To instruct koji to build these additional
arches, use this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">koji</span> <span class="nb">set</span><span class="o">-</span><span class="n">pkg</span><span class="o">-</span><span class="n">arches</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">arches</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">package</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">package2</span><span class="o">&gt;</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>Note: is a single entity, so denote multiple arches within quotes (e.g.
‘i386 i586 i686’).</p>
</div>
<div class="section" id="how-noarch-sub-packages-are-built">
<h4>How noarch sub-packages are built<a class="headerlink" href="#how-noarch-sub-packages-are-built" title="Permalink to this headline"></a></h4>
<p>It is a technical detail, but can make sense for someone debugging
noarch issues. If there are multiple architectures defined, multiple
<cite>buildArch</cite> tasks are spawned. Each of them will produce arch and also
noarch packages. While arch packages are unique compared to other
subtasks, noarch packages should be the same. It shouldn’t matter on
which arch you’re building it. If there is a difference, it is a bug.
Koji internally checks some data from these noarch packages and
chooses randomly one, which will appear in final builds. If
differences are found, build will fail. Koji is using simple embedded
rpmdiff variant, which checks for each file included in rpm: mode,
device, vflags, user, group, digest. Furthermore, Name, Summary,
Description, Group, License, URL, PreIn, PostIn, PreUn, PostUn,
Provides, Requires, Conflicts and Obsoletes are compared.  In case of
failing this test, <cite>BuildError</cite> is raised.</p>
</div>
<div class="section" id="manually-submitting-a-task">
<h4>Manually submitting a task<a class="headerlink" href="#manually-submitting-a-task" title="Permalink to this headline"></a></h4>
<p>Occasionally, you may need to manually submit a task to koji. One likely
usage is to manually trigger a createRepo. To do this, use this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">koji</span> <span class="n">make</span><span class="o">-</span><span class="n">task</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">arg1</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">arg2</span><span class="o">&gt;...</span><span class="p">]</span>
</pre></div>
</div>
<p>The make-task command is a bit of under-documented black magic. Task
parameters are defined in kojihub.py. The easiest way I have found to
figure out the right incantations for make-task is to query the <em>task</em>
table in the koji database directly. Find a similar task to the one you
want to create, and look in the request field for the parameters the
task used, and mimic those.</p>
<p>So, citing the createRepo case above, here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kojiadmin@localhost$ koji make-task --channel=createrepo --priority=15 \
newRepo dist-foo-build
</pre></div>
</div>
</div>
<div class="section" id="managing-your-tags">
<h4>Managing your tags<a class="headerlink" href="#managing-your-tags" title="Permalink to this headline"></a></h4>
<p>Occasionally an unwanted package or version of a package will be built
by koji. Don’t fret. There are two mechanisms to handle rescinding a
package or specific package version.</p>
<ul class="simple">
<li><p>To remove a specific version of a package, you can untag it:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">koji</span> <span class="n">untag</span><span class="o">-</span><span class="n">build</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">pkg</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">pkg</span><span class="o">&gt;...</span><span class="p">]</span>

<span class="n">supports</span> <span class="n">either</span> <span class="o">%</span><span class="n">name</span> <span class="ow">or</span> <span class="o">%</span><span class="n">name</span><span class="o">-%</span><span class="n">version</span><span class="o">-%</span><span class="n">release</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To remove all versions of a package, you can untag it as above or you
can administratively block it from being listed in a tag:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">koji</span> <span class="n">block</span><span class="o">-</span><span class="n">pkg</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="n">tag</span> <span class="n">package</span> <span class="p">[</span><span class="n">package2</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="spec-file-processing">
<h3>Spec file processing<a class="headerlink" href="#spec-file-processing" title="Permalink to this headline"></a></h3>
<div class="section" id="macro-processing">
<h4>Macro processing<a class="headerlink" href="#macro-processing" title="Permalink to this headline"></a></h4>
<p>Macros in the spec file are expanded before Requires and BuildRequires
are processed. If there are any custom macros in the spec file, the
package that drops those macros into /etc/rpm must be tagged under your
dist-build tag</p>
<div class="section" id="dist-tags">
<h5>%dist tags<a class="headerlink" href="#dist-tags" title="Permalink to this headline"></a></h5>
<p>For packages that incorporate the %dist tags in their filename, they
expect %dist to be defined in /etc/rpm/macros.dist, which was added in
Fedora 7. For building on RHEL5/FC6 and earlier, koji needs the
<a class="reference external" href="https://buildsys.fedoraproject.org/buildgroups/buildsys-macros">https://buildsys.fedoraproject.org/buildgroups/
buildsys-macros</a>
package tagged under the dist-build tag.</p>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="HOWTO.html" class="btn btn-neutral float-left" title="Koji HOWTO" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="runs_here.html" class="btn btn-neutral float-right" title="Runs Here" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Mike McLean, Mike B, Dennis Gilmore, Mathieu Bridon, Ian McLeod, Ralph Bean, Adam Miller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>