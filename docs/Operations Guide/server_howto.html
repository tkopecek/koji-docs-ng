<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Server Installation &mdash; Koji alpha documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Koji Server Bootstrap" href="server_bootstrap.html" />
    <link rel="prev" title="Operations Guide" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Koji
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Operations Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Server Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-a-koji-build-system">Setting Up a Koji Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quick-start">Quick Start</a></li>
<li class="toctree-l3"><a class="reference internal" href="#knowledge-prerequisites">Knowledge Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#package-prerequisites">Package Prerequisites</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#on-the-server-koji-hub">On the server (koji-hub)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-the-database-server-koji-hub-or-separate-machine">On the database server (koji-hub or separate machine)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-the-web-server-koji-web">On the web server (koji-web)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-the-builder-koji-builder">On the builder (koji-builder)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-the-utility-server-kojira">On the utility server (kojira)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-the-windows-builder-koji-vm">On the windows builder (koji-vm)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#a-note-on-filesystem-space">A note on filesystem space</a></li>
<li class="toctree-l3"><a class="reference internal" href="#koji-authentication-selection">Koji Authentication Selection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-ssl-certificates-for-authentication">Setting up SSL Certificates for authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-kerberos-for-authentication">Setting up Kerberos for authentication</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#postgresql-server">PostgreSQL Server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuration-files">Configuration Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-postgresql">Install PostgreSQL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initialize-postgresql-db">Initialize PostgreSQL DB:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setup-user-accounts">Setup User Accounts:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setup-postgresql-and-populate-schema">Setup PostgreSQL and populate schema:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authorize-koji-hub-to-postgresql">Authorize Koji-hub to PostgreSQL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bootstrapping-the-initial-koji-admin-user-into-the-postgresql-database">Bootstrapping the initial koji admin user into the PostgreSQL database</a></li>
<li class="toctree-l4"><a class="reference internal" href="#maintaining-database">Maintaining database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#koji-hub">Koji Hub</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Configuration Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-koji-hub">Install koji-hub</a></li>
<li class="toctree-l4"><a class="reference internal" href="#required-configuration">Required Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-configuration">Authentication Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#koji-cli-the-standard-client">Koji cli - The standard client</a></li>
<li class="toctree-l3"><a class="reference internal" href="#koji-web-interface-for-the-masses">Koji Web - Interface for the Masses</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Configuration Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-koji-web">Install Koji-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Required Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#filesystem-configuration">Filesystem Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#web-interface-now-operational">Web interface now operational</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#koji-daemon-builder">Koji Daemon - Builder</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">Configuration Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-kojid">Install kojid</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Required Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-configuration-ssl-certificates">Authentication Configuration (SSL certificates)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-configuration-kerberos">Authentication Configuration (Kerberos)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#source-control-configuration">Source Control Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-the-host-to-the-createrepo-channel">Add the host to the createrepo channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#a-note-on-capacity">A note on capacity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#start-kojid">Start Kojid</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kojira-dnf-repository-creation-and-maintenance">Kojira - Dnf repository creation and maintenance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">Configuration Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-kojira">Install kojira</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">Required Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#auth-config">Authentication Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#start-kojira">Start Kojira</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bootstrapping-the-koji-build-environment">Bootstrapping the Koji build environment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="server_bootstrap.html">Koji Server Bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="volumes.html">Storage Volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="external_repo_server_bootstrap.html">External Repository Server Bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="kerberos_gssapi_debug.html">Koji Kerberos/GSSAPI debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="kojid_conf.html">Builder Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="hub_conf.html">Hub Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="database_howto.html">Database Performance Howto</a></li>
<li class="toctree-l2"><a class="reference internal" href="image_build.html">Building Images in Koji</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html">Koji Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">Tasks Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="containers.html">Running Koji in Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="supported_platforms.html">Supported Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases.html">Releases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Administration%20Guide/index.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../User%20Guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developer%20Guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../runs_here.html">Runs Here</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Koji</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Operations Guide</a> &raquo;</li>
      <li>Server Installation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Operations Guide/server_howto.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="server-installation">
<h1>Server Installation<a class="headerlink" href="#server-installation" title="Permalink to this headline"></a></h1>
<div class="section" id="setting-up-a-koji-build-system">
<h2>Setting Up a Koji Build System<a class="headerlink" href="#setting-up-a-koji-build-system" title="Permalink to this headline"></a></h2>
<p>The Koji components may <strong>live</strong> on separate resources as long as all resources
are able to communicate. This document will cover how to setup each service
individually, however, all services may <strong>live</strong> on the same resource.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Everything except the builders themselves can run also in containers.
Builders have to be run in more privileged and separated environment. For
details look into <a class="reference internal" href="containers.html"><span class="doc">Running Koji in Containers</span></a></p>
</div>
</div>
<div class="section" id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline"></a></h2>
<p>As a production deployment administrator you’ll probably want to get into deep
how koji components interact. But if you want something to play with, to
understand how koji works or to do some koji development, you can start with
quick setup via vagrant/ansible provided by <a class="reference external" href="https://github.com/ktdreyer/koji-playbooks">koji-playbooks</a> project. Simple
<code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">up</span></code> should get you working environment where all needed services are
run on the same VM with default user and kerberos authentication.</p>
<p>Of course, even production deployment can be done using those playbooks, but it
is recommended to at least read the following sections to understand which
decisions need to be made and which options are really important.</p>
</div>
<div class="section" id="knowledge-prerequisites">
<h2>Knowledge Prerequisites<a class="headerlink" href="#knowledge-prerequisites" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Basic understanding of SSL and authentication via certificates and/or
Kerberos credentials</p></li>
<li><p>Basic knowledge about creating a database in PostgreSQL and importing a schema</p></li>
<li><p>Working with <code class="docutils literal notranslate"><span class="pre">psql</span></code></p></li>
<li><p>Basic knowledge about Apache configuration</p></li>
<li><p>Basic knowledge about <a class="reference external" href="https://fedoraproject.org/wiki/Dnf">dnf</a>/<a class="reference external" href="https://fedoraproject.org/wiki/Yum">yum</a>/<a class="reference external" href="http://createrepo.baseurl.org/">createrepo</a>/<a class="reference external" href="https://fedoraproject.org/wiki/Mock">mock</a> - else you’ll not
be able to debug problems!</p></li>
<li><p>Basic knowledge about using command line</p></li>
<li><p>Basic knowledge about RPM building</p></li>
<li><p>Simple usage of the Koji client</p></li>
<li><p>For an overview of dnf, yum, mock, Koji (and all its subcomponents), mash, and how
they all work together, see the excellent slides put together by <a class="reference external" href="http://indico.cern.ch/event/55091">Steve
Traylen at CERN</a>.</p></li>
</ul>
</div>
<div class="section" id="package-prerequisites">
<h2>Package Prerequisites<a class="headerlink" href="#package-prerequisites" title="Permalink to this headline"></a></h2>
<p>We will assume Fedora 35 / CentOS 8 versions as a starting environment. If
you’re using other versions be aware of potential differences.</p>
<div class="section" id="on-the-server-koji-hub">
<h3>On the server (koji-hub)<a class="headerlink" href="#on-the-server-koji-hub" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>koji-hub</p></li>
<li><p>mod_ssl</p></li>
<li><p>mod_auth_gssapi</p></li>
</ul>
</div>
<div class="section" id="on-the-database-server-koji-hub-or-separate-machine">
<h3>On the database server (koji-hub or separate machine)<a class="headerlink" href="#on-the-database-server-koji-hub-or-separate-machine" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>postgresql-server</p></li>
</ul>
</div>
<div class="section" id="on-the-web-server-koji-web">
<h3>On the web server (koji-web)<a class="headerlink" href="#on-the-web-server-koji-web" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>koji-web</p></li>
</ul>
</div>
<div class="section" id="on-the-builder-koji-builder">
<h3>On the builder (koji-builder)<a class="headerlink" href="#on-the-builder-koji-builder" title="Permalink to this headline"></a></h3>
<p>For basic builder</p>
<ul class="simple">
<li><p>koji-builder</p></li>
</ul>
<p>For builders running also <a class="reference internal" href="tasks.html"><span class="doc">newRepo/distRepo</span></a> tasks</p>
<ul class="simple">
<li><p>createrepo_c</p></li>
</ul>
<p>For image builders</p>
<ul class="simple">
<li><p>building via ImageFactory</p>
<ul>
<li><p>imagefactory-*</p></li>
<li><p>oz</p></li>
</ul>
</li>
<li><p>building via Appliance Creator</p>
<ul>
<li><p>python3-pykickstart</p></li>
<li><p>appliance-tools</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="on-the-utility-server-kojira">
<h3>On the utility server (kojira)<a class="headerlink" href="#on-the-utility-server-kojira" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>koji-utils</p></li>
</ul>
</div>
<div class="section" id="on-the-windows-builder-koji-vm">
<h3>On the windows builder (koji-vm)<a class="headerlink" href="#on-the-windows-builder-koji-vm" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>koji-vm</p></li>
</ul>
</div>
</div>
<div class="section" id="a-note-on-filesystem-space">
<h2>A note on filesystem space<a class="headerlink" href="#a-note-on-filesystem-space" title="Permalink to this headline"></a></h2>
<p>Koji will consume copious amounts of disk space under the primary <code class="docutils literal notranslate"><span class="pre">KojiDir</span></code>
directory (as set in the <a class="reference internal" href="hub_conf.html"><span class="doc">kojihub.conf</span></a> file - defaults to
<code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code>).  However, as koji makes use of mock on the backend to actually
create build roots and perform the builds in those build roots, it might come to
a surprise to users that a running koji server will consume large amounts of
disk space under <code class="docutils literal notranslate"><span class="pre">/var/lib/mock</span></code> and <code class="docutils literal notranslate"><span class="pre">/var/cache/mock</span></code> as well. Users should
either plan the disk and filesystem allocations for this, or plan to modify the
default mock build directory in the kojid.conf file. If you change the location,
ensure that the new directories are owned by the group “mock” and have 02755
permission.</p>
</div>
<div class="section" id="koji-authentication-selection">
<h2>Koji Authentication Selection<a class="headerlink" href="#koji-authentication-selection" title="Permalink to this headline"></a></h2>
<p>Koji primarily supports Kerberos and SSL Certificate authentication. For basic
koji command line access, plain user/pass combinations are possible.  However,
kojiweb does <strong>not</strong> support plain user/pass authentication and once either
Kerberos or SSL Certificate authentication is enabled for kojiweb, the plain
user/pass method will stop working entirely.  For this reason we encourage
skipping the plain user/pass method altogether and properly configuring either
Kerberos or SSL Certification authentication from the start.</p>
<p>The decision on how to authenticate users will affect all other actions you
take in setting up koji. For this reason it is a decision best made up front.</p>
<dl class="simple">
<dt>For Kerberos authentication</dt><dd><p>a working Kerberos environment (the user is assumed to either already have
this or know how to set it up themselves, instructions for it are not
included here) and the Kerberos credentials of the initial admin user will
be necessary to bootstrap the user database.</p>
</dd>
<dt>For SSL authentication</dt><dd><p>SSL certificates for the xmlrpc server, for the various koji components,
and one for the admin user will need to be setup (the user need not know
how to create certificate chains already, we include the instructions for
this below).</p>
</dd>
</dl>
<div class="section" id="setting-up-ssl-certificates-for-authentication">
<h3>Setting up SSL Certificates for authentication<a class="headerlink" href="#setting-up-ssl-certificates-for-authentication" title="Permalink to this headline"></a></h3>
<p>For quick generation <code class="docutils literal notranslate"><span class="pre">koji-ssl-admin</span></code> from <a class="reference external" href="https://pagure.io/koji-tools">koji-tools</a> is the recommended
way. For manual setup follow the next sections. Note, that if you’re using
<a class="reference external" href="https://github.com/ktdreyer/koji-playbooks">koji-playbooks</a> this script is used internally to generate required
certificates.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dnf -y install python3-cryptography
<span class="gp">$ </span>curl -O https://pagure.io/koji-tools/raw/master/f/src/bin/koji-ssl-admin
<span class="gp">$ </span>chmod +x koji-ssl-admin
<span class="gp">$ </span>./koji-ssl-admin new-ca --common-name <span class="s2">&quot;My Koji CA&quot;</span>
<span class="go">wrote koji-ca.key - protect this private file</span>
<span class="go">wrote koji-ca.crt - publish this for users</span>
<span class="gp">$ </span>./koji-ssl-admin server-csr kojihub.example.com
<span class="go">wrote kojihub.example.com.key - protect this private file</span>
<span class="go">wrote kojihub.example.com.csr - sign this with a CA</span>
<span class="gp">$ </span>./koji-ssl-admin sign kojihub.example.com.csr
<span class="go">wrote kojihub.example.com.crt - publish this for users</span>
<span class="go">wrote kojihub.example.com.chain.crt - use this in the HTTP server config</span>
<span class="gp">$ </span>./koji-ssl-admin sign kojiadmin.csr
<span class="go">wrote kojiadmin.crt - publish this for users</span>
<span class="go">wrote kojiadmin.cert for koji CLI - protect this private file</span>
<span class="go">wrote kojiadmin_browser_cert.p12 for kojiweb - protect this private file</span>
<span class="go">to import kojiadmin_browser_cert.p12 into browser, the password is &quot;koji&quot;</span>
</pre></div>
</div>
<p>These steps are described in the following subsections if you want to understand
what is going on under the hood or if you want to finetune the process. If
you’re ok with these defaults (testing instance, etc.) continue with the next
section.</p>
<div class="section" id="certificate-generation">
<h4>Certificate generation<a class="headerlink" href="#certificate-generation" title="Permalink to this headline"></a></h4>
<p>Create the <code class="docutils literal notranslate"><span class="pre">/etc/pki/koji</span></code> directory and copy-and-paste the ssl.cnf listed
here, and save it in the new directory. This configuration file is used along
with the <code class="docutils literal notranslate"><span class="pre">openssl</span></code> command to generate the SSL certificates for the various
koji components.</p>
<p><code class="docutils literal notranslate"><span class="pre">ssl.cnf</span></code></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">HOME</span>                    <span class="o">=</span> <span class="s">.</span>
<span class="na">RANDFILE</span>                <span class="o">=</span> <span class="s">.rand</span>

<span class="k">[ca]</span>
<span class="na">default_ca</span>              <span class="o">=</span> <span class="s">ca_default</span>

<span class="k">[ca_default]</span>
<span class="na">dir</span>                     <span class="o">=</span> <span class="s">.</span>
<span class="na">certs</span>                   <span class="o">=</span> <span class="s">$dir/certs</span>
<span class="na">crl_dir</span>                 <span class="o">=</span> <span class="s">$dir/crl</span>
<span class="na">database</span>                <span class="o">=</span> <span class="s">$dir/index.txt</span>
<span class="na">new_certs_dir</span>           <span class="o">=</span> <span class="s">$dir/newcerts</span>
<span class="na">certificate</span>             <span class="o">=</span> <span class="s">$dir/%s_ca_cert.pem</span>
<span class="na">private_key</span>             <span class="o">=</span> <span class="s">$dir/private/%s_ca_key.pem</span>
<span class="na">serial</span>                  <span class="o">=</span> <span class="s">$dir/serial</span>
<span class="na">crl</span>                     <span class="o">=</span> <span class="s">$dir/crl.pem</span>
<span class="na">x509_extensions</span>         <span class="o">=</span> <span class="s">usr_cert</span>
<span class="na">name_opt</span>                <span class="o">=</span> <span class="s">ca_default</span>
<span class="na">cert_opt</span>                <span class="o">=</span> <span class="s">ca_default</span>
<span class="na">default_days</span>            <span class="o">=</span> <span class="s">3650</span>
<span class="na">default_crl_days</span>        <span class="o">=</span> <span class="s">30</span>
<span class="na">default_md</span>              <span class="o">=</span> <span class="s">sha256</span>
<span class="na">preserve</span>                <span class="o">=</span> <span class="s">no</span>
<span class="na">policy</span>                  <span class="o">=</span> <span class="s">policy_match</span>

<span class="k">[policy_match]</span>
<span class="na">countryName</span>             <span class="o">=</span> <span class="s">match</span>
<span class="na">stateOrProvinceName</span>     <span class="o">=</span> <span class="s">match</span>
<span class="na">organizationName</span>        <span class="o">=</span> <span class="s">match</span>
<span class="na">organizationalUnitName</span>  <span class="o">=</span> <span class="s">optional</span>
<span class="na">commonName</span>              <span class="o">=</span> <span class="s">supplied</span>
<span class="na">emailAddress</span>            <span class="o">=</span> <span class="s">optional</span>

<span class="k">[req]</span>
<span class="na">default_bits</span>            <span class="o">=</span> <span class="s">2048</span>
<span class="na">default_keyfile</span>         <span class="o">=</span> <span class="s">privkey.pem</span>
<span class="na">default_md</span>              <span class="o">=</span> <span class="s">sha256</span>
<span class="na">distinguished_name</span>      <span class="o">=</span> <span class="s">req_distinguished_name</span>
<span class="na">attributes</span>              <span class="o">=</span> <span class="s">req_attributes</span>
<span class="na">x509_extensions</span>         <span class="o">=</span> <span class="s">v3_ca # The extensions to add to the self signed cert</span>
<span class="na">string_mask</span>             <span class="o">=</span> <span class="s">MASK:0x2002</span>

<span class="k">[req_distinguished_name]</span>
<span class="na">countryName</span>                     <span class="o">=</span> <span class="s">Country Name (2 letter code)</span>
<span class="na">countryName_default</span>             <span class="o">=</span> <span class="s">AT</span>
<span class="na">countryName_min</span>                 <span class="o">=</span> <span class="s">2</span>
<span class="na">countryName_max</span>                 <span class="o">=</span> <span class="s">2</span>
<span class="na">stateOrProvinceName</span>             <span class="o">=</span> <span class="s">State or Province Name (full name)</span>
<span class="na">stateOrProvinceName_default</span>     <span class="o">=</span> <span class="s">Vienna</span>
<span class="na">localityName</span>                    <span class="o">=</span> <span class="s">Locality Name (eg, city)</span>
<span class="na">localityName_default</span>            <span class="o">=</span> <span class="s">Vienna</span>
<span class="na">0.organizationName</span>              <span class="o">=</span> <span class="s">Organization Name (eg, company)</span>
<span class="na">0.organizationName_default</span>      <span class="o">=</span> <span class="s">My company</span>
<span class="na">organizationalUnitName</span>          <span class="o">=</span> <span class="s">Organizational Unit Name (eg, section)</span>
<span class="na">commonName</span>                      <span class="o">=</span> <span class="s">Common Name (eg, your name or your server\&#39;s hostname)</span>
<span class="na">commonName_max</span>                  <span class="o">=</span> <span class="s">64</span>
<span class="na">emailAddress</span>                    <span class="o">=</span> <span class="s">Email Address</span>
<span class="na">emailAddress_max</span>                <span class="o">=</span> <span class="s">64</span>

<span class="k">[req_attributes]</span>
<span class="na">challengePassword</span>               <span class="o">=</span> <span class="s">A challenge password</span>
<span class="na">challengePassword_min</span>           <span class="o">=</span> <span class="s">4</span>
<span class="na">challengePassword_max</span>           <span class="o">=</span> <span class="s">20</span>
<span class="na">unstructuredName</span>                <span class="o">=</span> <span class="s">An optional company name</span>

<span class="k">[usr_cert]</span>
<span class="na">basicConstraints</span>                <span class="o">=</span> <span class="s">CA:FALSE</span>
<span class="na">nsComment</span>                       <span class="o">=</span> <span class="s">&quot;OpenSSL Generated Certificate&quot;</span>
<span class="na">subjectKeyIdentifier</span>            <span class="o">=</span> <span class="s">hash</span>
<span class="na">authorityKeyIdentifier</span>          <span class="o">=</span> <span class="s">keyid,issuer:always</span>

<span class="k">[v3_ca]</span>
<span class="na">subjectKeyIdentifier</span>            <span class="o">=</span> <span class="s">hash</span>
<span class="na">authorityKeyIdentifier</span>          <span class="o">=</span> <span class="s">keyid:always,issuer:always</span>
<span class="na">basicConstraints</span>                <span class="o">=</span> <span class="s">CA:true</span>
</pre></div>
</div>
<p>Although it is not required, it is recommended that you edit the default values
in the <code class="docutils literal notranslate"><span class="pre">[req_distinguished_name]</span></code> section of the configuration to match the
information for your own server. This will allow you to accept most of the
default values when generating certificates later. The other sections can be
left unedited.</p>
</div>
<div class="section" id="generate-ca">
<h4>Generate CA<a class="headerlink" href="#generate-ca" title="Permalink to this headline"></a></h4>
<p>The CA is the Certificate Authority.  It’s the key/cert pair used to sign all
the other certificate requests.  When configuring the various koji components,
both the client CA and the server CA will be a copy of the CA generated here.
The CA certificate will be placed in the <code class="docutils literal notranslate"><span class="pre">/etc/pki/koji</span></code> directory and the
certificates for the other components will be placed in the
<code class="docutils literal notranslate"><span class="pre">/etc/pki/koji/certs</span></code> directory. The <code class="docutils literal notranslate"><span class="pre">index.txt</span></code> file which is created is
a database of the certificates generated and can be used to view the
information for any of the certificates simply by viewing the contents of
<code class="docutils literal notranslate"><span class="pre">index.txt</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span><span class="nb">cd</span> /etc/pki/koji/
<span class="gp">root@localhost$ </span>mkdir <span class="o">{</span>certs,private,confs<span class="o">}</span>
<span class="gp">root@localhost$ </span>touch index.txt
<span class="gp">root@localhost$ </span><span class="nb">echo</span> <span class="m">01</span> &gt; serial
<span class="gp">root@localhost$ </span>openssl genrsa -out private/koji_ca_cert.key <span class="m">2048</span>
<span class="gp">root@localhost$ </span>openssl req -config ssl.cnf -new -x509 -days <span class="m">3650</span> <span class="se">\</span>
<span class="go">                -key private/koji_ca_cert.key -out koji_ca_cert.crt -extensions v3_ca</span>
</pre></div>
</div>
<p>The last command above will ask you to confirm a number of items about the
certificate you are generating. Presumably you already edited the defaults for
the country, state/province, locale, and organization in the <code class="docutils literal notranslate"><span class="pre">ssl.cnf</span></code> file
and you only needed to hit enter. It’s the organizational unit and the common
name that we will be changing in the various certs we create. For the CA
itself, these fields don’t have a hard requirement. One suggestion for this
certificate is to use the FQDN of the server.</p>
<p>If you are trying to automate this process via a configuration management
tool, you can create the cert in one command with a line like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>openssl req -config ssl.cnf -new -x509 <span class="se">\</span>
<span class="go">                -subj &quot;/C=US/ST=Oregon/L=Portland/O=IT/CN=koji.example.com&quot; \</span>
<span class="go">                -days 3650 -key private/koji_ca_cert.key -out koji_ca_cert.crt \</span>
<span class="go">                -extensions v3_ca</span>
</pre></div>
</div>
</div>
<div class="section" id="generate-the-koji-component-certificates-and-the-admin-certificate">
<h4>Generate the koji component certificates and the admin certificate<a class="headerlink" href="#generate-the-koji-component-certificates-and-the-admin-certificate" title="Permalink to this headline"></a></h4>
<p>Each koji component needs its own certificate to identify it. Two of the
certificates (kojihub and kojiweb) are used as server side certificates that
authenticate the server to the client. For this reason, you want the common
name on both of those certs to be the fully qualified domain name of the web
server they are running on so that clients don’t complain about the common
name and the server not being the same. You can set the OU for these two
certificates to be kojihub and kojiweb for identification purposes.</p>
<p>For the other certificates (kojira, kojid, the initial admin account, and all
user certificates), the cert is used to authenticate the client to the server.
The common name for these certs should be set to the login name for that
specific component. For example the common name for the kojira cert should be
set to kojira so that it matches the username. The reason for this is that the
common name of the cert will be matched to the corresponding user name in the
koji database. If there is not a username in the database which matches the CN
of the cert the client will not be authenticated and access will be denied.</p>
<p>When you later use <code class="docutils literal notranslate"><span class="pre">koji</span> <span class="pre">add-host</span></code> to add a build machine into the koji
database, it creates a user account for that host even though the user account
doesn’t appear in the user list.  The user account created must match the
common name of the certificate which that component uses to authenticate with
the server. When creating the kojiweb certificate, you’ll want to remember
exactly what values you enter for each field as you’ll have to regurgitate
those into the <code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/hub.conf</span></code> file as the <code class="docutils literal notranslate"><span class="pre">ProxyDNs</span></code> entry.</p>
<p>When you need to create multiple certificates it may be convenient to create a
loop or a script like the on listed below and run the script to create the
certificates. You can simply adjust the number of kojibuilders and the name of
the admin account as you see fit. For much of this guide, the admin account is
called <code class="docutils literal notranslate"><span class="pre">kojiadmin</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># if you change your certificate authority name to something else you will</span>
<span class="c1"># need to change the caname value to reflect the change.</span>
<span class="nv">caname</span><span class="o">=</span>koji

<span class="c1"># user is equal to parameter one or the first argument when you actually</span>
<span class="c1"># run the script</span>
<span class="nv">user</span><span class="o">=</span><span class="nv">$1</span>

openssl genrsa -out private/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.key <span class="m">2048</span>
cat ssl.cnf <span class="p">|</span> sed <span class="s1">&#39;s/insert_hostname/&#39;</span><span class="si">${</span><span class="nv">user</span><span class="si">}</span><span class="s1">&#39;/&#39;</span>&gt; ssl2.cnf
openssl req -config ssl2.cnf -new -nodes -out certs/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.csr -key private/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.key
openssl ca -config ssl2.cnf -keyfile private/<span class="si">${</span><span class="nv">caname</span><span class="si">}</span>_ca_cert.key -cert <span class="si">${</span><span class="nv">caname</span><span class="si">}</span>_ca_cert.crt <span class="se">\</span>
    -out certs/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.crt -outdir certs -infiles certs/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.csr
cat certs/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.crt private/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.key &gt; <span class="si">${</span><span class="nv">user</span><span class="si">}</span>.pem
mv ssl2.cnf confs/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>-ssl.cnf
</pre></div>
</div>
</div>
<div class="section" id="generate-a-pkcs12-user-certificate-for-web-browser">
<h4>Generate a PKCS12 user certificate (for web browser)<a class="headerlink" href="#generate-a-pkcs12-user-certificate-for-web-browser" title="Permalink to this headline"></a></h4>
<p>This is only required for user certificates.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl pkcs12 -export -inkey private/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.key -in certs/<span class="si">${</span><span class="nv">user</span><span class="si">}</span>.crt <span class="se">\</span>
<span class="go">    -CAfile ${caname}_ca_cert.crt -out certs/${user}_browser_cert.p12</span>
</pre></div>
</div>
<p>When generating certs for a user, the user will need the <code class="docutils literal notranslate"><span class="pre">${user}.pem</span></code>, the
<code class="docutils literal notranslate"><span class="pre">${caname}_ca_cert.crt</span></code>, and the <code class="docutils literal notranslate"><span class="pre">${user}_browser_cert.p12</span></code> files which
were generated above.  The ${user}.pem file would normally be installed as
<code class="docutils literal notranslate"><span class="pre">~/.fedora.cert</span></code>, the <code class="docutils literal notranslate"><span class="pre">${caname}_ca_cert.crt</span></code> file would be installed as
both <code class="docutils literal notranslate"><span class="pre">~/.fedora-upload-ca.cert</span></code> and <code class="docutils literal notranslate"><span class="pre">~/.fedora-server-ca.cert</span></code>, and the
user would import the <code class="docutils literal notranslate"><span class="pre">${user}_brower_cert.p12</span></code> into their web browser as a
personal certificate.</p>
</div>
<div class="section" id="copy-certificates-into-koji-for-kojiadmin">
<h4>Copy certificates into ~/.koji for kojiadmin<a class="headerlink" href="#copy-certificates-into-koji-for-kojiadmin" title="Permalink to this headline"></a></h4>
<p>You’re going to want to be able to send admin commands to the kojihub. In order
to do so, you’ll need to use the newly created certificates to authenticate
with the hub. Create the kojiadmin user then copy the certificates for the koji
CA and the kojiadmin user to <code class="docutils literal notranslate"><span class="pre">~/.koji</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">kojiadmin@localhost$ </span>mkdir ~/.koji
<span class="gp">kojiadmin@localhost$ </span>cp /etc/pki/koji/kojiadmin.pem ~/.koji/client.crt   <span class="c1"># NOTE: It is IMPORTANT you use the PEM and NOT the CRT</span>
<span class="gp">kojiadmin@localhost$ </span>cp /etc/pki/koji/koji_ca_cert.crt ~/.koji/clientca.crt
<span class="gp">kojiadmin@localhost$ </span>cp /etc/pki/koji/koji_ca_cert.crt ~/.koji/serverca.crt
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <code class="docutils literal notranslate"><span class="pre">/etc/koji.conf</span></code> for the current system wide koji client configuration.
Copy <code class="docutils literal notranslate"><span class="pre">/etc/koji.conf</span></code> to <code class="docutils literal notranslate"><span class="pre">~/.koji/config</span></code> if you wish to change the config
on a per user basis.</p>
</div>
</div>
</div>
<div class="section" id="setting-up-kerberos-for-authentication">
<h3>Setting up Kerberos for authentication<a class="headerlink" href="#setting-up-kerberos-for-authentication" title="Permalink to this headline"></a></h3>
<p>The initial configuration of a kerberos service is outside the scope of this
document, however there are a few specific things required by koji.</p>
<div class="section" id="dns">
<h4>DNS<a class="headerlink" href="#dns" title="Permalink to this headline"></a></h4>
<p>The koji builders (kojid) use DNS to find the kerberos servers for any given
realm.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">_kerberos._udp    IN SRV  10 100 88 kerberos.EXAMPLE.COM.</span>
</pre></div>
</div>
<p>The trailing dot denotes DNS root and is needed if FQDN is used.</p>
</div>
<div class="section" id="principals-and-keytabs">
<h4>Principals and Keytabs<a class="headerlink" href="#principals-and-keytabs" title="Permalink to this headline"></a></h4>
<p>It should be noted that in general you will need to use the fully qualified
domain name of the hosts when generating the keytabs for services.</p>
<p>You will need the following principals extracted to a keytab for a fully
kerberized configuration, the requirement for a host key for the koji-hub is
currently hard coded into the koji client.</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">host/kojihub&#64;EXAMPLE.COM</span></code></dt><dd><p>Used by the koji-hub server when communicating with the koji client</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HTTP/kojiweb&#64;EXAMPLE.COM</span></code></dt><dd><p>Used by the koji-web server when performing a negotiated Kerberos
authentication with a web browser. This is a service principal for
Apache’s mod_auth_gssapi.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">koji/kojiweb&#64;EXAMPLE.COM</span></code></dt><dd><p>Used by the koji-web server during communications with the koji-hub. This
is a user principal that will authenticate koji-web to Kerberos as
“<a class="reference external" href="mailto:koji/kojiweb&#37;&#52;&#48;EXAMPLE&#46;COM">koji/kojiweb<span>&#64;</span>EXAMPLE<span>&#46;</span>COM</a>”. Koji-web will proxy the mod_auth_gssapi user
information to koji-hub (the <code class="docutils literal notranslate"><span class="pre">ProxyPrincipals</span></code> koji-hub config
option).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">koji/kojira&#64;EXAMPLE.COM</span></code></dt><dd><p>Used by the kojira server during communications with the koji-hub</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">compile/builder1.example.com&#64;EXAMPLE.COM</span></code></dt><dd><p>Used on builder1 to communicate with the koji-hub. This
is a user principal that will authenticate koji-builder to Kerberos as
“<a class="reference external" href="mailto:compile/builder1&#46;example&#46;com&#37;&#52;&#48;EXAMPLE&#46;COM">compile/builder1<span>&#46;</span>example<span>&#46;</span>com<span>&#64;</span>EXAMPLE<span>&#46;</span>COM</a>”. Each builder host will have
its own unique Kerberos user principal to authenticate to the hub.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="postgresql-server">
<h2>PostgreSQL Server<a class="headerlink" href="#postgresql-server" title="Permalink to this headline"></a></h2>
<p>Once the authentication scheme has been setup your will need to install and
configure a PostgreSQL server and prime the database which will be used to hold
the koji users.</p>
<div class="section" id="configuration-files">
<h3>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/data/pg_hba.conf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/data/postgresql.conf</span></code></p></li>
</ul>
</div>
<div class="section" id="install-postgresql">
<h3>Install PostgreSQL<a class="headerlink" href="#install-postgresql" title="Permalink to this headline"></a></h3>
<p>Install the <code class="docutils literal notranslate"><span class="pre">postgresql-server</span></code> package:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>dnf install postgresql-server
</pre></div>
</div>
</div>
<div class="section" id="initialize-postgresql-db">
<h3>Initialize PostgreSQL DB:<a class="headerlink" href="#initialize-postgresql-db" title="Permalink to this headline"></a></h3>
<p>Initialize PostgreSQL:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>postgresql-setup --initdb --unit postgresql
</pre></div>
</div>
<p>And start the database service:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>systemctl <span class="nb">enable</span> postgresql --now
</pre></div>
</div>
</div>
<div class="section" id="setup-user-accounts">
<h3>Setup User Accounts:<a class="headerlink" href="#setup-user-accounts" title="Permalink to this headline"></a></h3>
<p>The following commands will setup the <code class="docutils literal notranslate"><span class="pre">koji</span></code> account and assign it a password</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>useradd koji
<span class="gp">root@localhost$ </span>passwd koji
</pre></div>
</div>
</div>
<div class="section" id="setup-postgresql-and-populate-schema">
<h3>Setup PostgreSQL and populate schema:<a class="headerlink" href="#setup-postgresql-and-populate-schema" title="Permalink to this headline"></a></h3>
<p>The following commands will:</p>
<ul class="simple">
<li><p>create the koji user within PostgreSQL</p></li>
<li><p>create the koji database within PostgreSQL</p></li>
<li><p>set a password for the koji user</p></li>
<li><p>create the koji schema using the provided
<code class="docutils literal notranslate"><span class="pre">/usr/share/doc/koji*/docs/schema.sql</span></code> file from the <code class="docutils literal notranslate"><span class="pre">koji</span></code> package.</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>su - postgres
<span class="gp">postgres@localhost$ </span>createuser --no-superuser --no-createrole --no-createdb koji
<span class="gp">postgres@localhost$ </span>createdb -O koji koji
<span class="gp">postgres@localhost$ </span>psql -c <span class="s2">&quot;alter user koji with encrypted password &#39;mypassword&#39;;&quot;</span>
<span class="gp">postgres@localhost$ </span><span class="nb">logout</span>
<span class="gp">root@localhost$ </span>yum -y install koji
<span class="gp">root@localhost$ </span>su - koji
<span class="gp">koji@localhost$ </span>psql koji koji &lt; /usr/share/doc/koji*/docs/schema.sql
<span class="gp">koji@localhost$ </span><span class="nb">exit</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When issuing the command to import the psql schema into the new database it
is important to ensure that the directory path
<code class="docutils literal notranslate"><span class="pre">/usr/share/doc/koji*/docs/schema.sql</span></code> remains intact and is not resolved to
a specific version of koji. In test it was discovered that when the path is
resolved to a specific version of koji then not all of the tables were
created correctly.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When issuing the command to import the psql schema into the new database it
is important to ensure that you are logged in as the koji database owner.
This will ensure all objects are owned by the koji database user. Upgrades
may be difficult if this was not done correctly.</p>
</div>
</div>
<div class="section" id="authorize-koji-hub-to-postgresql">
<h3>Authorize Koji-hub to PostgreSQL<a class="headerlink" href="#authorize-koji-hub-to-postgresql" title="Permalink to this headline"></a></h3>
<p>Koji-hub is the only service that needs direct access to the database. Every
other Koji service talks with the koji-hub via the API calls.</p>
<div class="section" id="example-everything-on-localhost">
<h4>Example: Everything on localhost<a class="headerlink" href="#example-everything-on-localhost" title="Permalink to this headline"></a></h4>
<p>In this example, the koji-hub Apache server is running on the same system
as the PostgreSQL server, so we can use local-only connections over a Unix
domain socket.</p>
<ol class="arabic">
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/data/pg_hba.conf</span></code> to have the following
contents:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>TYPE   DATABASE    USER    CIDR-ADDRESS      METHOD
<span class="go">local   koji        koji                       trust</span>
<span class="go">local   all         postgres                   peer</span>
</pre></div>
</div>
<p>Explanation:</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">local</span></code> connection type means the postgres connection uses a local
Unix socket, so PostgreSQL is not exposed over TCP/IP at all.</p></li>
<li><p>The local <code class="docutils literal notranslate"><span class="pre">koji</span></code> user should only have access to the <code class="docutils literal notranslate"><span class="pre">koji</span></code> database.
The local <code class="docutils literal notranslate"><span class="pre">postgres</span></code> user will have access to everything (in order to
create the <code class="docutils literal notranslate"><span class="pre">koji</span></code> database and user.)</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">CIDR-ADDRESS</span></code> column is blank, because this example only uses
local Unix sockets.</p></li>
<li><p>The <a class="reference external" href="https://www.postgresql.org/docs/current/auth-trust.html">trust</a>
method means that PosgreSQL will permit any connections from any local
user for this username. We set this for the <code class="docutils literal notranslate"><span class="pre">koji</span></code> user because Apache
httpd runs as the <code class="docutils literal notranslate"><span class="pre">apache</span></code> system user rather than the <code class="docutils literal notranslate"><span class="pre">koji</span></code> user
when it connects to the Unix socket. <code class="docutils literal notranslate"><span class="pre">trust</span></code> is not secure on a
multi-user system, but it is fine for a single-purpose Koji system.</p>
<p>The <a class="reference external" href="https://www.postgresql.org/docs/current/auth-peer.html">peer</a>
method means that PostgreSQL will obtain the client’s operating system
username and use that as the allowed username. This is safer than
<code class="docutils literal notranslate"><span class="pre">trust</span></code> because only the local <code class="docutils literal notranslate"><span class="pre">postgres</span></code> system user will be able to
access PostgreSQL with this level of access.</p>
</li>
</ul>
</li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/data/postgresql.conf</span></code> and set <code class="docutils literal notranslate"><span class="pre">listen_addresses</span></code>
to prevent TCP/IP access entirely:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">listen_addresses = &#39;&#39;</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="example-separate-postgresql-and-apache-servers">
<h4>Example: Separate PostgreSQL and Apache servers<a class="headerlink" href="#example-separate-postgresql-and-apache-servers" title="Permalink to this headline"></a></h4>
<p>In this example, the PostgreSQL server “db.example.com” is running on one
host, and the koji-hub Apache server talks to this PostgreSQL server over the
network. The koji-hub Apache server has an IP address of 192.0.2.1 (IPv4) and
2001:db8::1 (IPv6), so we authorize connections from both addresses for the
<code class="docutils literal notranslate"><span class="pre">koji</span></code> user account.</p>
<ol class="arabic">
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/data/pg_hba.conf</span></code> to have the following contents:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>TYPE   DATABASE    USER    CIDR-ADDRESS      METHOD
<span class="go">host    koji        koji    192.0.2.1/32       md5</span>
<span class="go">host    koji        koji    2001:db8::1/128    md5</span>
<span class="go">local   all         postgres                   peer</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">md5</span></code> authentication mechanism is available in PostgreSQL 9 (RHEL 7).
On PostgreSQL 10 (RHEL 8+ and Fedora), use the stronger <code class="docutils literal notranslate"><span class="pre">scram-sha-256</span></code>
mechanism instead, and set <code class="docutils literal notranslate"><span class="pre">password_encryption</span> <span class="pre">=</span> <span class="pre">scram-sha-256</span></code> in
<code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code>.</p>
</li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">/var/lib/pgsql/data/postgresql.conf</span></code> and set <code class="docutils literal notranslate"><span class="pre">listen_addresses</span></code>
so that PostgreSQL will listen on all network interfaces:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">listen_addresses = &#39;*&#39;</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="activating-changes">
<h4>Activating changes<a class="headerlink" href="#activating-changes" title="Permalink to this headline"></a></h4>
<p>You must reload the PostgreSQL daemon to activate changes to
<code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> or <code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>systemctl reload postgresql
</pre></div>
</div>
</div>
</div>
<div class="section" id="bootstrapping-the-initial-koji-admin-user-into-the-postgresql-database">
<h3>Bootstrapping the initial koji admin user into the PostgreSQL database<a class="headerlink" href="#bootstrapping-the-initial-koji-admin-user-into-the-postgresql-database" title="Permalink to this headline"></a></h3>
<p>You must add the initial admin user manually to the user database using sql
commands.  Once you have bootstrapped this initial admin user, you may add
additional users and change privileges of those users via the koji command
line tool.</p>
<p>However, if you decided to use the simple user/pass method of authentication,
then any password setting/changing must be done manually via sql commands as
there is no password manipulation support exposed through the koji tools.</p>
<p>The sql commands you need to use vary by authentication mechanism.</p>
</div>
<div class="section" id="maintaining-database">
<span id="db-maintenance"></span><h3>Maintaining database<a class="headerlink" href="#maintaining-database" title="Permalink to this headline"></a></h3>
<p>For now, there is one table which needs periodical cleanup. As postgres doesn’t
have any mechanism for this, we need to do it via some other mechanism. Default
handling is done by cron, but can be substituted by anything else (Ansible
tower, etc.)</p>
<p>Script is by default installed on hub as <code class="docutils literal notranslate"><span class="pre">/usr/sbin/koji-sweep-db</span></code>.  It has
also corresponding <code class="docutils literal notranslate"><span class="pre">koji-sweep-db</span></code> service and timer. Note, that timer is not
enabled by default, so you need to run usual <code class="docutils literal notranslate"><span class="pre">systemctl</span></code> commands:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>systemctl <span class="nb">enable</span> --now koji-sweep-db.timer
</pre></div>
</div>
<p>If you don’t want to use this script, be sure to run following SQL with
appropriate age setting. Default value of one day should be ok for most
deployments. As there will be tons of freed records, additional VACUUM can be
handy.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">sessions</span> <span class="k">WHERE</span> <span class="n">update_time</span> <span class="o">&lt;</span> <span class="n">NOW</span><span class="p">()</span> <span class="o">-</span> <span class="s1">&#39;1 day&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">;</span>
<span class="k">VACUUM</span> <span class="k">ANALYZE</span> <span class="n">sessions</span><span class="p">;</span>
</pre></div>
</div>
<p>Optionally (if you’re using <a class="reference internal" href="../Developer%20Guide/content_generators.html#cg-api"><span class="std std-ref">reservation API</span></a> for
content generators), you would want to run also reservation cleanup:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">build_reservations</span> <span class="k">WHERE</span> <span class="n">update_time</span> <span class="o">&lt;</span> <span class="n">NOW</span><span class="p">()</span> <span class="o">-</span> <span class="s1">&#39;1 day&#39;</span><span class="p">::</span><span class="nb">interval</span><span class="p">;</span>
<span class="k">VACUUM</span> <span class="k">ANALYZE</span> <span class="n">build_reservations</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="set-user-password-authentication">
<h4>Set User/Password Authentication<a class="headerlink" href="#set-user-password-authentication" title="Permalink to this headline"></a></h4>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>su - koji
<span class="gp">koji@localhost$ </span>psql
<span class="go">koji=&gt; INSERT INTO users (name, password, status, usertype) VALUES (&#39;admin-user-name&#39;, &#39;admin-password-in-plain-text&#39;, 0, 0);</span>
</pre></div>
</div>
</div>
<div class="section" id="kerberos-authentication">
<h4>Kerberos authentication<a class="headerlink" href="#kerberos-authentication" title="Permalink to this headline"></a></h4>
<p>The process is very similar to user/pass except you would replace the first
insert above with this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>su - koji
<span class="gp">koji@localhost$ </span>psql &lt;&lt;EOF
<span class="go">WITH user_id AS (</span>
<span class="go">    INSERT INTO users (name, status, usertype) VALUES (&#39;admin-user-name&#39;, 0, 0) RETURNING id</span>
<span class="go">)</span>
<span class="go">INSERT INTO user_krb_principals (user_id, krb_principal) VALUES (</span>
<span class="go">    (SELECT id FROM user_id),</span>
<span class="go">    &#39;admin@EXAMPLE&#39;</span>
<span class="go">);</span>
<span class="go">EOF</span>
</pre></div>
</div>
</div>
<div class="section" id="ssl-certificate-authentication">
<h4>SSL Certificate authentication<a class="headerlink" href="#ssl-certificate-authentication" title="Permalink to this headline"></a></h4>
<p>There is no need for either a password or a Kerberos principal, so this will
suffice:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>su - koji
<span class="gp">koji@localhost$ </span>psql
<span class="go">koji=&gt; INSERT INTO users (name, status, usertype) VALUES (&#39;admin-user-name&#39;, 0, 0);</span>
</pre></div>
</div>
</div>
<div class="section" id="give-yourself-admin-permissions">
<h4>Give yourself admin permissions<a class="headerlink" href="#give-yourself-admin-permissions" title="Permalink to this headline"></a></h4>
<p>The following command will give the user admin permissions. In order to do
this you will need to know the ID of the user.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">koji=&gt; INSERT INTO user_perms (user_id, perm_id, creator_id) VALUES (&lt;id of user inserted above&gt;, 1, &lt;id of user inserted above&gt;);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you do not know the ID of the admin user, you can get the ID by running the query:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">koji=&gt; SELECT * FROM users;</span>
</pre></div>
</div>
</div>
<p>You can’t actually log in and perform any actions until kojihub is up and
running in your web server.  In order to get to that point you still need to
complete the authentication setup and the kojihub configuration. If you wish
to access koji via a web browser, you will also need to get kojiweb up and
running.</p>
</div>
</div>
</div>
<div class="section" id="koji-hub">
<h2>Koji Hub<a class="headerlink" href="#koji-hub" title="Permalink to this headline"></a></h2>
<p>Koji-hub is the center of all Koji operations. It is an XML-RPC server running
under mod_wsgi in the Apache httpd. koji-hub is passive in that it only
receives XML-RPC calls and relies upon the build daemons and other components
to initiate communication. Koji-hub is the only component that has direct
access to the database and is one of the two components that have write access
to the file system.</p>
<div class="section" id="id1">
<h3>Configuration Files<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/hub.conf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/hub.conf.d/*</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf/httpd.conf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/kojihub.conf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/ssl.conf</span></code> (when using ssl auth)</p></li>
</ul>
</div>
<div class="section" id="install-koji-hub">
<h3>Install koji-hub<a class="headerlink" href="#install-koji-hub" title="Permalink to this headline"></a></h3>
<p>Install the <code class="docutils literal notranslate"><span class="pre">koji-hub</span></code> package along with mod_ssl:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>dnf install koji-hub mod_ssl
</pre></div>
</div>
</div>
<div class="section" id="required-configuration">
<h3>Required Configuration<a class="headerlink" href="#required-configuration" title="Permalink to this headline"></a></h3>
<p>We provide example configs for all services, so look for <code class="docutils literal notranslate"><span class="pre">httpd.conf</span></code>, <code class="docutils literal notranslate"><span class="pre">hub.conf</span></code>,
<code class="docutils literal notranslate"><span class="pre">kojiweb.conf</span></code> and <code class="docutils literal notranslate"><span class="pre">web.conf</span></code> in source repo or related rpms. Furthermore,
documentation for all options in <a class="reference internal" href="hub_conf.html"><span class="doc">hub.conf</span></a> is provided.</p>
<div class="section" id="etc-httpd-conf-httpd-conf">
<h4>/etc/httpd/conf/httpd.conf<a class="headerlink" href="#etc-httpd-conf-httpd-conf" title="Permalink to this headline"></a></h4>
<p>The apache web server has two places that it sets maximum requests a server
will handle before the server restarts. The xmlrpc interface in kojihub is a
python application, and processes can sometimes grow outrageously large when it
doesn’t reap memory often enough. As a result, it is strongly recommended that
you set both instances of <code class="docutils literal notranslate"><span class="pre">MaxConnectionsPerChild</span></code> in <code class="docutils literal notranslate"><span class="pre">httpd.conf</span></code> to
something reasonable in order to prevent the server from becoming overloaded
and crashing (at 100 the httpd processes will grow to about 75MB resident set
size before respawning).</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;IfModule</span> <span class="s">prefork.c</span><span class="nt">&gt;</span>
        ...
        <span class="nb">MaxConnectionsPerChild</span>  <span class="m">100</span>
<span class="nt">&lt;/IfModule&gt;</span>
<span class="nt">&lt;IfModule</span> <span class="s">worker.c</span><span class="nt">&gt;</span>
        ...
        <span class="nb">MaxConnectionsPerChild</span>  <span class="m">100</span>
<span class="nt">&lt;/IfModule&gt;</span>
<span class="nt">&lt;IfModule</span> <span class="s">event.c</span><span class="nt">&gt;</span>
        ...
        <span class="nb">MaxRequestsPerChild</span>  <span class="m">100</span>
<span class="nt">&lt;/IfModule&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="etc-httpd-conf-d-kojihub-conf">
<h4>/etc/httpd/conf.d/kojihub.conf<a class="headerlink" href="#etc-httpd-conf-d-kojihub-conf" title="Permalink to this headline"></a></h4>
<p>The koji-hub package provides this configuration file. You will need to modify
it based on your authentication type. Instructions are contained within the
file and should be simple to follow.</p>
<p>For example, if you are using SSL authentication, you will want to uncomment
the section that looks like this:</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="c"># uncomment this to enable authentication via SSL client certificates</span>
<span class="c"># &lt;Location /kojihub/ssllogin&gt;</span>
<span class="c">#         SSLVerifyClient require</span>
<span class="c">#         SSLVerifyDepth  10</span>
<span class="c">#         SSLOptions +StdEnvVars</span>
<span class="c"># &lt;/Location&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="etc-httpd-conf-d-ssl-conf">
<h4>/etc/httpd/conf.d/ssl.conf<a class="headerlink" href="#etc-httpd-conf-d-ssl-conf" title="Permalink to this headline"></a></h4>
<p>If you are configuring your server for httpd (and you really should), then your
<code class="docutils literal notranslate"><span class="pre">SSLCertificate*</span></code> directives will generally live in the main <code class="docutils literal notranslate"><span class="pre">ssl.conf</span></code> file.
This part is mostly independent of Koji.
It’s something you would do for any httpd instance.</p>
<p>The part that matters to Koji is this –
if you are using SSL authentication, then the CA certificate you configure
in <code class="docutils literal notranslate"><span class="pre">SSLCACertificateFile</span></code> here should be the same one that you use to issue
user certificates.</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nb">SSLCertificateFile</span> <span class="sx">/etc/pki/koji/certs/kojihub.crt</span>
<span class="nb">SSLCertificateKeyFile</span> <span class="sx">/etc/pki/koji/private/kojihub.key</span>
<span class="nb">SSLCertificateChainFile</span> <span class="sx">/etc/pki/koji/koji_ca_cert.crt</span>
<span class="nb">SSLCACertificateFile</span> <span class="sx">/etc/pki/koji/koji_ca_cert.crt</span>
</pre></div>
</div>
</div>
<div class="section" id="etc-koji-hub-hub-conf">
<h4>/etc/koji-hub/hub.conf<a class="headerlink" href="#etc-koji-hub-hub-conf" title="Permalink to this headline"></a></h4>
<p>This file contains the configuration information for the hub. You will need to
edit this configuration to point Koji Hub to the database you are using and to
setup Koji Hub to utilize the authentication scheme you selected in the
beginning.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">DBName</span> <span class="o">=</span> <span class="s">koji</span>
<span class="na">DBUser</span> <span class="o">=</span> <span class="s">koji</span>

<span class="c1"># If PostgreSQL is on another host, set that here:</span>
<span class="c1">#DBHost = db.example.com</span>
<span class="c1">#DBPass = mypassword</span>

<span class="na">KojiDir</span> <span class="o">=</span> <span class="s">/mnt/koji</span>
<span class="na">LoginCreatesUser</span> <span class="o">=</span> <span class="s">On</span>
<span class="na">KojiWebURL</span> <span class="o">=</span> <span class="s">http://kojiweb.example.com/koji</span>
</pre></div>
</div>
<p>If koji-hub is running on the same server as PostgreSQL and you are using Unix
sockets to query the database, omit the <code class="docutils literal notranslate"><span class="pre">DBHost</span></code>, <code class="docutils literal notranslate"><span class="pre">DBPort</span></code>, and <code class="docutils literal notranslate"><span class="pre">DBPass</span></code>
variables. Do not set <code class="docutils literal notranslate"><span class="pre">DBHost</span></code> to <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, or else PostgreSQL will
attempt to connect with TCP through <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> instead of using the Unix
socket.</p>
<p>If koji-hub is running on a separate server from PostgreSQL, you must set the
<code class="docutils literal notranslate"><span class="pre">DBHost</span></code> and <code class="docutils literal notranslate"><span class="pre">DBPass</span></code> options. You must also configure SELinux to allow
Apache to connect to the remote PostgreSQL server:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>setsebool -P <span class="nv">httpd_can_network_connect_db</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Note, that database connection parameters (password) are sensitive values.
Config is installed by default with 0640 root/apache file permissions. If you’re
not installing hub from rpm double-check these permissions.</p>
<p>Furthermore, you can install any config file in <code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/hub.conf.d</span></code>
directory. These files are read <em>at first</em> and main config is allowed to
override all these values. So, you can use e.g.
<code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/hub.conf.d/secret.conf</span></code> for sensitive values. Typical usecase
for separate config is <a class="reference internal" href="../Administration%20Guide/defining_hub_policies.html"><span class="doc">policy</span></a> configuration file.</p>
<p>All options are covered in detail <a class="reference internal" href="hub_conf.html"><span class="doc">here</span></a> .</p>
</div>
</div>
<div class="section" id="authentication-configuration">
<h3>Authentication Configuration<a class="headerlink" href="#authentication-configuration" title="Permalink to this headline"></a></h3>
<div class="section" id="id2">
<h4>/etc/koji-hub/hub.conf<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h4>
<p>If using Kerberos, these settings need to be valid and inline with other
services configurations.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">AuthPrincipal host/kojihub@EXAMPLE.COM</span>
<span class="na">AuthKeytab /etc/koji.keytab</span>
<span class="na">ProxyPrincipals koji/kojiweb@EXAMPLE.COM</span>
<span class="na">HostPrincipalFormat compile/%s@EXAMPLE.COM</span>
</pre></div>
</div>
<p>If using SSL auth, these settings need to be valid and inline with other
services configurations for kojiweb to allow logins.</p>
<p>ProxyDNs should be set to the DN of the kojiweb certificate. For example:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">DNUsernameComponent</span> <span class="o">=</span> <span class="s">CN</span>
<span class="na">ProxyDNs</span> <span class="o">=</span> <span class="s">CN=example.com,OU=kojiweb,O=Example Org,ST=Massachusetts,C=US</span>
</pre></div>
</div>
</div>
<div class="section" id="koji-filesystem-skeleton">
<h4>Koji filesystem skeleton<a class="headerlink" href="#koji-filesystem-skeleton" title="Permalink to this headline"></a></h4>
<p>Above in the <code class="docutils literal notranslate"><span class="pre">kojihub.conf</span></code> file we set KojiDir to <code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code>.  For
certain reasons, if you change this, you should make a symlink from
<code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code> to the new location (note: this is a bug and should be fixed
eventually).  However, before other parts of koji will operate properly, we
need to create a skeleton filesystem structure for koji as well as make the
file area owned by apache so that the xmlrpc interface can write to it as
needed.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span><span class="nb">cd</span> /mnt
<span class="gp">root@localhost$ </span>mkdir koji
<span class="gp">root@localhost$ </span><span class="nb">cd</span> koji
<span class="gp">root@localhost$ </span>mkdir <span class="o">{</span>packages,repos,work,scratch,repos-dist<span class="o">}</span>
<span class="gp">root@localhost$ </span>chown apache.apache *
</pre></div>
</div>
</div>
<div class="section" id="selinux-configuration">
<h4>SELinux Configuration<a class="headerlink" href="#selinux-configuration" title="Permalink to this headline"></a></h4>
<p>Configure SELinux to allow Apache write access to <code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>setsebool -P <span class="nv">allow_httpd_anon_write</span><span class="o">=</span><span class="m">1</span>
<span class="gp">root@localhost$ </span>semanage fcontext -a -t public_content_rw_t <span class="s2">&quot;/mnt/koji(/.*)?&quot;</span>
<span class="gp">root@localhost$ </span>restorecon -r -v /mnt/koji
</pre></div>
</div>
<p>If you’ve placed <code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code> on an NFS share, enable a separate boolean to
allow Apache access to NFS:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>setsebool -P <span class="nv">httpd_use_nfs</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div>
<div class="section" id="check-your-configuration">
<h4>Check Your Configuration<a class="headerlink" href="#check-your-configuration" title="Permalink to this headline"></a></h4>
<p>At this point, you can now restart apache and you should have at least minimal
operation.  The admin user should be able to connect via the command line
client, add new users, etc.  It’s possible at this time to undertake initial
administrative steps such as adding users and hosts to the koji database.</p>
<p>So we will need a working client to test with.</p>
</div>
</div>
</div>
<div class="section" id="koji-cli-the-standard-client">
<h2>Koji cli - The standard client<a class="headerlink" href="#koji-cli-the-standard-client" title="Permalink to this headline"></a></h2>
<p>The koji cli is the standard client. It can perform most tasks and is essential
to the successful use of any koji environment.</p>
<p>Ensure that your client is configured to work with your server. The system-wide
koji client configuration file is <code class="docutils literal notranslate"><span class="pre">/etc/koji.conf</span></code>, and the user-specific one
is in <code class="docutils literal notranslate"><span class="pre">~/.koji/config</span></code>. You may also use the <code class="docutils literal notranslate"><span class="pre">-c</span></code> option when using the
Koji client to specify an alternative configuration file.</p>
<p>If you are using SSL for authentication, you will need to edit the Koji client
configuration to tell it which URLs to use for the various Koji components and
where their SSL certificates can be found.</p>
<p>For a simple test, all we need is the <code class="docutils literal notranslate"><span class="pre">server</span></code> and authentication sections.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[koji]</span>

<span class="c1">;url of XMLRPC server</span>
<span class="na">server</span> <span class="o">=</span> <span class="s">http://koji-hub.example.com/kojihub</span>

<span class="c1">;url of web interface</span>
<span class="na">weburl</span> <span class="o">=</span> <span class="s">http://koji-web.example.com/koji</span>

<span class="c1">;url of package download site</span>
<span class="na">topurl</span> <span class="o">=</span> <span class="s">http://koji-filesystem.example.com/kojifiles</span>

<span class="c1">;path to the koji top directory</span>
<span class="na">topdir</span> <span class="o">=</span> <span class="s">/mnt/koji</span>

<span class="c1">; configuration for SSL athentication</span>

<span class="c1">;client certificate</span>
<span class="na">cert</span> <span class="o">=</span> <span class="s">~/.koji/client.crt</span>

<span class="c1">;certificate of the CA that issued the HTTP server certificate</span>
<span class="na">serverca</span> <span class="o">=</span> <span class="s">~/.koji/serverca.crt</span>
</pre></div>
</div>
<p>The following command will test your login to the hub:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>koji moshimoshi
<span class="go">Hello, kojiadmin!</span>

<span class="go">You are using the hub at https://koji-hub.example.com/kojihub</span>
<span class="go">Authenticated via GSSAPI</span>
</pre></div>
</div>
</div>
<div class="section" id="koji-web-interface-for-the-masses">
<h2>Koji Web - Interface for the Masses<a class="headerlink" href="#koji-web-interface-for-the-masses" title="Permalink to this headline"></a></h2>
<p>Koji-web is a set of scripts that run in mod_wsgi and use the Cheetah
templating engine to provide an web interface to Koji. koji-web exposes a lot
of information and also provides a means for certain operations, such as
cancelling builds.</p>
<div class="section" id="id3">
<h3>Configuration Files<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/kojiweb.conf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/ssl.conf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/kojiweb/web.conf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/kojiweb/web.conf.d/*</span></code></p></li>
</ul>
</div>
<div class="section" id="install-koji-web">
<h3>Install Koji-Web<a class="headerlink" href="#install-koji-web" title="Permalink to this headline"></a></h3>
<p>Install the <code class="docutils literal notranslate"><span class="pre">koji-web</span></code> package along with mod_ssl:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>dnf install koji-web mod_ssl
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Required Configuration<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h3>
<div class="section" id="etc-httpd-conf-d-kojiweb-conf">
<h4>/etc/httpd/conf.d/kojiweb.conf<a class="headerlink" href="#etc-httpd-conf-d-kojiweb-conf" title="Permalink to this headline"></a></h4>
<p>The koji-web package provides this configuration file. You will need to modify
it based on your authentication type. Instructions are contained within the
file and should be simple to follow.</p>
<p>For example, if you are using SSL authentication, you would want to uncomment
the section that looks like this:</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="c"># uncomment this to enable authentication via SSL client certificates</span>
<span class="c"># &lt;Location /koji/login&gt;</span>
<span class="c">#     SSLVerifyClient require</span>
<span class="c">#     SSLVerifyDepth  10</span>
<span class="c">#     SSLOptions +StdEnvVars</span>
<span class="c"># &lt;/Location&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>/etc/httpd/conf.d/ssl.conf<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h4>
<p>Similarly to the hub configuration, if you are using https (as you should),
then you will need to configure your certificates.
This is something you might do for any httpd instance and is mostly independent
of Koji.</p>
<p>If you are using SSL authentication, then the CA certificate you configure
in <code class="docutils literal notranslate"><span class="pre">SSLCACertificateFile</span></code> here should be the same one that you use to issue
user certificates.</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nb">SSLCertificateFile</span> <span class="sx">/etc/pki/koji/certs/kojihub.crt</span>
<span class="nb">SSLCertificateKeyFile</span> <span class="sx">/etc/pki/koji/private/kojihub.key</span>
<span class="nb">SSLCertificateChainFile</span> <span class="sx">/etc/pki/koji/koji_ca_cert.crt</span>
<span class="nb">SSLCACertificateFile</span> <span class="sx">/etc/pki/koji/koji_ca_cert.crt</span>
</pre></div>
</div>
</div>
<div class="section" id="etc-kojiweb-web-conf">
<h4>/etc/kojiweb/web.conf<a class="headerlink" href="#etc-kojiweb-web-conf" title="Permalink to this headline"></a></h4>
<p>You will need to edit the kojiweb configuration file to tell kojiweb which URLs
it should use to access the hub, the koji packages and its own web interface.
You will also need to tell kojiweb where it can find the SSL certificates for
each of these components. If you are using SSL authentication, the “WebCert”
line below must contain both the public <strong>and</strong> private key. You will also want
to change the last line in the example below to a unique password. Also check
the file permissions (due to Secret value) if you’re not installing koji web
from rpm (0640, root/apache by default).</p>
<p>Furthermore, you can install any config file in <code class="docutils literal notranslate"><span class="pre">/etc/kojiweb/web.conf.d</span></code>
directory. These files are read <em>at first</em> and main config is allowed to
override all these values. So, you can use e.g.
<code class="docutils literal notranslate"><span class="pre">/etc/kojiweb/web.conf.d/secret.conf</span></code> for sensitive values.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[web]</span>
<span class="na">SiteName</span> <span class="o">=</span> <span class="s">koji</span>
<span class="c1"># KojiTheme =</span>

<span class="c1"># Necessary urls</span>
<span class="na">KojiHubURL</span> <span class="o">=</span> <span class="s">https://koji-hub.example.com/kojihub</span>
<span class="na">KojiFilesURL</span> <span class="o">=</span> <span class="s">http://koji-filesystem.example.com/kojifiles</span>

<span class="c1">## Kerberos authentication options</span>
<span class="c1">; WebPrincipal = koji/web@EXAMPLE.COM</span>
<span class="c1">; WebKeytab = /etc/httpd.keytab</span>
<span class="c1">; WebCCache = /var/tmp/kojiweb.ccache</span>

<span class="c1">## SSL authentication options</span>
<span class="c1">; WebCert = /etc/pki/koji/koji-web.pem</span>
<span class="c1">; KojiHubCA = /etc/pki/koji/ca_cert.crt</span>

<span class="na">LoginTimeout</span> <span class="o">=</span> <span class="s">72</span>

<span class="c1"># This must be set before deployment</span>
<span class="c1">#Secret = CHANGE_ME</span>

<span class="na">LibPath</span> <span class="o">=</span> <span class="s">/usr/share/koji-web/lib</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="filesystem-configuration">
<h3>Filesystem Configuration<a class="headerlink" href="#filesystem-configuration" title="Permalink to this headline"></a></h3>
<p>You’ll need to make <code class="docutils literal notranslate"><span class="pre">/mnt/koji/</span></code> web-accessible, either here, on the hub, or
on another web server altogether.</p>
<p>This URL will go into various clients such as:
* <code class="docutils literal notranslate"><span class="pre">/etc/kojiweb/web.conf</span></code> as KojiFilesURL
* <code class="docutils literal notranslate"><span class="pre">/etc/kojid/kojid.conf</span></code> as topurl
* <code class="docutils literal notranslate"><span class="pre">/etc/koji.conf</span></code> as topurl</p>
<div class="highlight-apacheconf notranslate"><div class="highlight"><pre><span></span><span class="nb">Alias</span> <span class="sx">/kojifiles/</span> <span class="sx">/mnt/koji/</span>
<span class="nt">&lt;Directory</span> <span class="s">&quot;/mnt/koji/&quot;</span><span class="nt">&gt;</span>
    <span class="nb">Options</span> Indexes
    <span class="nb">AllowOverride</span> <span class="k">None</span>
    <span class="c"># Apache &lt; 2.4</span>
    <span class="c">#   Order allow,deny</span>
    <span class="c">#   Allow from all</span>
    <span class="c"># Apache &gt;= 2.4</span>
    <span class="nb">Require</span> <span class="k">all</span> granted
<span class="nt">&lt;/Directory&gt;</span>
</pre></div>
</div>
<p>Wherever you configure this, please go back and set it correctly in
<code class="docutils literal notranslate"><span class="pre">/etc/kojiweb/web.conf</span></code> now.</p>
</div>
<div class="section" id="web-interface-now-operational">
<h3>Web interface now operational<a class="headerlink" href="#web-interface-now-operational" title="Permalink to this headline"></a></h3>
<p>At this point you should be able to point your web browser at the kojiweb URL
and be presented with the koji interface.  Many operations should work in read
only mode at this point, and any configured users should be able to log in.</p>
</div>
</div>
<div class="section" id="koji-daemon-builder">
<h2>Koji Daemon - Builder<a class="headerlink" href="#koji-daemon-builder" title="Permalink to this headline"></a></h2>
<p>Kojid is the build daemon that runs on each of the build machines. Its primary
responsibility is polling for incoming build requests and handling them
accordingly. Koji also has support for tasks other than building such as
creating livecd images or raw disk images, and kojid is responsible for
handling these tasks as well. The kojid service uses mock for creating pristine
build environments and creates a fresh one for every build, ensuring that
artifacts of build processes cannot contaminate each other. All of kojid is
written in Python and communicates with koji-hub via XML-RPC.</p>
<div class="section" id="id6">
<h3>Configuration Files<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/kojid/kojid.conf</span></code> - Koji Daemon Configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/kojid</span></code> - Koji Daemon Switches</p></li>
</ul>
<p>All options for <cite>kojid.conf</cite> are described <a class="reference internal" href="kojid_conf.html"><span class="doc">here</span></a>.</p>
</div>
<div class="section" id="install-kojid">
<h3>Install kojid<a class="headerlink" href="#install-kojid" title="Permalink to this headline"></a></h3>
<p>Install the <code class="docutils literal notranslate"><span class="pre">koji-builder</span></code> package:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>dnf install koji-builder
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>Required Configuration<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h3>
<div class="section" id="add-the-host-entry-for-the-koji-builder-to-the-database">
<h4>Add the host entry for the koji builder to the database<a class="headerlink" href="#add-the-host-entry-for-the-koji-builder-to-the-database" title="Permalink to this headline"></a></h4>
<p>You will now need to add the koji builder to the database so that they can be
utilized by koji hub. Make sure you do this before you start kojid for the
first time, or you’ll need to manually remove entries from the sessions and
users table before it can be run successfully.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">kojiadmin@localhost$ </span>koji add-host kojibuilder1.example.com i386 x86_64
</pre></div>
</div>
<p>The first argument used after the <code class="docutils literal notranslate"><span class="pre">add-host</span></code> command should the hostname of
the builder. The second argument is used to specify the architecture which the
builder uses.</p>
</div>
<div class="section" id="etc-kojid-kojid-conf">
<h4>/etc/kojid/kojid.conf<a class="headerlink" href="#etc-kojid-kojid-conf" title="Permalink to this headline"></a></h4>
<p>Edit each koji builder’s <code class="docutils literal notranslate"><span class="pre">kojid.conf</span></code> file to point at the Koji hub:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; The URL for the xmlrpc server</span>
<span class="na">server</span><span class="o">=</span><span class="s">http://hub.example.com/kojihub</span>
</pre></div>
</div>
<p>Set the “user” value to the FQDN of the builder host. For example, if you
added the host with <code class="docutils literal notranslate"><span class="pre">koji</span> <span class="pre">add-host</span> <span class="pre">kojibuilder1.example.com</span></code>, set “user” to
kojibuilder1.example.com:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">user</span> <span class="o">=</span> <span class="s">kojibuilder1.example.com</span>
</pre></div>
</div>
<p>The builder must reach the filesystem over HTTP(S). Set “topurl” to the same
value that you’ve configured for Koji clients (above):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># The URL for the file access</span>
<span class="na">topurl</span><span class="o">=</span><span class="s">http://koji-filesystem.example.com/kojifiles</span>
</pre></div>
</div>
<p>If the “topurl” setting uses an HTTPS URL with a cert signed by a custom CA,
the Koji builder must trust the CA system-wide.</p>
<p>You may change “workdir”, but it may not be the same as <code class="docutils literal notranslate"><span class="pre">KojiDir</span></code> on the
<code class="docutils literal notranslate"><span class="pre">kojihub.conf</span></code> file. It can be something under <code class="docutils literal notranslate"><span class="pre">KojiDir</span></code>, just not the same as
<code class="docutils literal notranslate"><span class="pre">KojiDir</span></code>.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; The directory root for temporary storage</span>
<span class="na">workdir</span><span class="o">=</span><span class="s">/tmp/koji</span>
</pre></div>
</div>
<p>The root of the koji build directory (i.e., <code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code>) must be mounted on
the builder and configured as “topdir”. A Read-Only NFS mount is the easiest
way to handle this.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># The directory root where work data can be found from the koji hub</span>
<span class="na">topdir</span><span class="o">=</span><span class="s">/mnt/koji</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="authentication-configuration-ssl-certificates">
<h3>Authentication Configuration (SSL certificates)<a class="headerlink" href="#authentication-configuration-ssl-certificates" title="Permalink to this headline"></a></h3>
<div class="section" id="id8">
<h4>/etc/kojid/kojid.conf<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h4>
<p>If you are using SSL, edit these settings to point to the
certificates you generated at the beginning of the setup process.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">;client certificate</span>
<span class="c1">; This should reference the builder certificate we created on the kojihub CA, for kojibuilder1.example.com</span>
<span class="c1">; ALSO NOTE: This is the PEM file, NOT the crt</span>
<span class="na">cert</span> <span class="o">=</span> <span class="s">/etc/kojid/kojid.pem</span>

<span class="c1">;certificate of the CA that issued the HTTP server certificate</span>
<span class="na">serverca</span> <span class="o">=</span> <span class="s">/etc/kojid/koji_ca_cert.crt</span>
</pre></div>
</div>
<p>Every unique builder host must have its own unique keypair (PEM file) in
<code class="docutils literal notranslate"><span class="pre">/etc/kojid/</span></code>. If you generated the certificates on another host, move them
to each builder.</p>
</div>
</div>
<div class="section" id="authentication-configuration-kerberos">
<h3>Authentication Configuration (Kerberos)<a class="headerlink" href="#authentication-configuration-kerberos" title="Permalink to this headline"></a></h3>
<div class="section" id="id9">
<h4>/etc/kojid/kojid.conf<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h4>
<p>If using Kerberos, these settings need to be valid and inline with other
services configurations.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; the username has to be the same as what you used with add-host</span>
<span class="c1">;user =</span>

<span class="na">host_principal_format</span><span class="o">=</span><span class="s">compile/%s@EXAMPLE.COM</span>
</pre></div>
</div>
<p>By default it will look for the Kerberos keytab in <code class="docutils literal notranslate"><span class="pre">/etc/kojid/kojid.keytab</span></code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Kojid will not attempt kerberos authentication to the koji-hub unless the
username field is commented out</p>
</div>
</div>
</div>
<div class="section" id="source-control-configuration">
<span id="scm-config"></span><h3>Source Control Configuration<a class="headerlink" href="#source-control-configuration" title="Permalink to this headline"></a></h3>
<div class="section" id="id10">
<h4>/etc/kojid/kojid.conf<a class="headerlink" href="#id10" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">allowed_scms</span></code> setting controls which source control systems the builder
will accept. It is a space-separated list of entries in one of the following
forms:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">hostname:path[:use_common[:source_cmd]]</span>
<span class="na">!hostname:path</span>
</pre></div>
</div>
<p>where</p>
<blockquote>
<div><p><em>hostname</em> is a glob pattern matched against SCM hosts.</p>
<p><em>path</em> is a glob pattern matched against the SCM path.</p>
<p><em>use_common</em> is boolean setting (yes/no, on/off, true/false) that indicates
whether koji should also check out /common from the SCM host. The default
is on.</p>
<p><em>source_cmd</em> is a shell command to be run before building the
srpm, with commas instead of spaces. It defaults to <code class="docutils literal notranslate"><span class="pre">make,sources</span></code>.</p>
</div></blockquote>
<p>The second form (<code class="docutils literal notranslate"><span class="pre">!hostname:path</span></code>) is used to explicitly block a host:path
pattern. In particular, it provides the option to block specific subtrees of
a host, but allow from it otherwise</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">allowed_scms</span><span class="o">=</span>
    <span class="na">!scm-server.example.com:/blocked/path/*</span>
    <span class="na">scm-server.example.com:/repo/base/repos*/:no</span>
    <span class="na">alt-server.example.com:/repo/dist/repos*/:no:fedpkg,sources</span>
</pre></div>
</div>
<p>SCM checkout can contain multiple spec files (checkouted or created by
<code class="docutils literal notranslate"><span class="pre">source_cmd</span></code>). In such case spec file named same as a checkout directory will
be selected.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We provide <code class="docutils literal notranslate"><span class="pre">build_from_scm</span></code> hub policy as an equivalent in version 1.26.0.</p>
<p>For more details, please refer to <a class="reference internal" href="../Administration%20Guide/access_controls.html#allowed-scms"><span class="std std-ref">Allowed SCMs</span></a> and
<a class="reference internal" href="../Administration%20Guide/defining_hub_policies.html"><span class="doc">Defining Hub Policies</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="add-the-host-to-the-createrepo-channel">
<h3>Add the host to the createrepo channel<a class="headerlink" href="#add-the-host-to-the-createrepo-channel" title="Permalink to this headline"></a></h3>
<p>Channels are a way to control which builders process which tasks.  By default
hosts are added to the ‘’default’’ channel.  At least some build hosts also
needs to be added to the ‘’createrepo’’ channel so there will be someone to
process repo creation tasks initiated by kojira.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">kojiadmin@localhost$ </span>koji add-host-to-channel kojibuilder1.example.com createrepo
</pre></div>
</div>
</div>
<div class="section" id="a-note-on-capacity">
<h3>A note on capacity<a class="headerlink" href="#a-note-on-capacity" title="Permalink to this headline"></a></h3>
<p>The default capacity of a host added to the host database is 2. This means that
once the load average on that machine exceeds 2, kojid will not accept any
additional tasks. This is separate from the <code class="docutils literal notranslate"><span class="pre">maxjobs</span></code> item in the configuration
file. Before kojid will accept a job, it must pass both the test to ensure the
load average is below capacity and that the current number of jobs it is
already processing is less than maxjobs. However, in today’s modern age of quad
core and higher CPUs, a load average of 2 is generally insufficient to fully
utilize hardware.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>koji edit-host --capacity<span class="o">=</span><span class="m">16</span> kojibuilder1.example.com
</pre></div>
</div>
<p>The koji-web interface also offers the ability to edit this value to admin
accounts.</p>
</div>
<div class="section" id="start-kojid">
<h3>Start Kojid<a class="headerlink" href="#start-kojid" title="Permalink to this headline"></a></h3>
<p>Once the builder has been added to the database you must start kojid</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>systemctl <span class="nb">enable</span> kojid --now
</pre></div>
</div>
<p>Check <code class="docutils literal notranslate"><span class="pre">/var/log/kojid.log</span></code> to verify that kojid has started successfully. If
the log does not show any errors then the koji builder should be up and ready.
You can check this by pointing your web browser to the web interface and
clicking on the hosts tab. This will show you a list of builders in the
database and the status of each builder.</p>
</div>
</div>
<div class="section" id="kojira-dnf-repository-creation-and-maintenance">
<h2>Kojira - Dnf repository creation and maintenance<a class="headerlink" href="#kojira-dnf-repository-creation-and-maintenance" title="Permalink to this headline"></a></h2>
<div class="section" id="id11">
<h3>Configuration Files<a class="headerlink" href="#id11" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/kojira/kojira.conf</span></code> - Kojira Daemon Configuration</p></li>
</ul>
</div>
<div class="section" id="install-kojira">
<h3>Install kojira<a class="headerlink" href="#install-kojira" title="Permalink to this headline"></a></h3>
<p>Install the <code class="docutils literal notranslate"><span class="pre">koji-utils</span></code> package:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>dnf install koji-utils
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>Required Configuration<a class="headerlink" href="#id12" title="Permalink to this headline"></a></h3>
<div class="section" id="add-the-user-entry-for-the-kojira-user">
<h4>Add the user entry for the kojira user<a class="headerlink" href="#add-the-user-entry-for-the-kojira-user" title="Permalink to this headline"></a></h4>
<p>The kojira user requires the <code class="docutils literal notranslate"><span class="pre">repo</span></code> permission to function.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">kojiadmin@localhost$ </span>koji add-user kojira
<span class="gp">kojiadmin@localhost$ </span>koji grant-permission repo kojira
</pre></div>
</div>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">/etc/kojira/kojira.conf</span></code></dt><dd><p>This needs to point at your koji-hub.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; The URL for the xmlrpc server</span>
<span class="na">server</span><span class="o">=</span><span class="s">http://koji-hub.example.com/kojihub</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="additional-notes">
<h4>Additional Notes<a class="headerlink" href="#additional-notes" title="Permalink to this headline"></a></h4>
<ul class="simple">
<li><p>Kojira needs read-write access to <code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code>.</p></li>
<li><p>There should only be one instance of kojira running at any given time.</p></li>
<li><p>It is not recommended that kojira run on the builders, as builders only
should require read-only access to <code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code>.</p></li>
</ul>
</div>
</div>
<div class="section" id="auth-config">
<span id="id13"></span><h3>Authentication Configuration<a class="headerlink" href="#auth-config" title="Permalink to this headline"></a></h3>
<div class="section" id="etc-kojira-kojira-conf">
<h4>/etc/kojira/kojira.conf<a class="headerlink" href="#etc-kojira-kojira-conf" title="Permalink to this headline"></a></h4>
<p><strong>If using SSL,</strong> these settings need to be valid.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">;client certificate</span>
<span class="c1">; This should reference the kojira certificate we created above</span>
<span class="na">cert</span> <span class="o">=</span> <span class="s">/etc/pki/koji/kojira.pem</span>

<span class="c1">;certificate of the CA that issued the HTTP server certificate</span>
<span class="na">serverca</span> <span class="o">=</span> <span class="s">/etc/pki/koji/koji_ca_cert.crt</span>
</pre></div>
</div>
<p><strong>If using Kerberos,</strong> these settings need to be valid.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">;configuration for Kerberos authentication</span>

<span class="c1">;the kerberos principal to use</span>
<span class="c1">;principal = kojira@EXAMPLE.COM</span>

<span class="c1">;location of the keytab</span>
<span class="c1">;keytab = /etc/kojira/kojira.keytab</span>
</pre></div>
</div>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/kojira</span></code></dt><dd><p>The local user kojira runs as needs to be able to read and write to
<code class="docutils literal notranslate"><span class="pre">/mnt/koji/repos/</span></code>. If the volume that directory resides on is
root-squashed or otherwise unmodifiable by root, you can set <code class="docutils literal notranslate"><span class="pre">RUNAS=</span></code> to
a user that has the required privileges.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="start-kojira">
<h3>Start Kojira<a class="headerlink" href="#start-kojira" title="Permalink to this headline"></a></h3>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@localhost$ </span>systemctl <span class="nb">enable</span> kojira --now
</pre></div>
</div>
<p>Check <code class="docutils literal notranslate"><span class="pre">/var/log/kojira/kojira.log</span></code> to verify that kojira has started
successfully.</p>
</div>
</div>
<div class="section" id="bootstrapping-the-koji-build-environment">
<h2>Bootstrapping the Koji build environment<a class="headerlink" href="#bootstrapping-the-koji-build-environment" title="Permalink to this headline"></a></h2>
<p>For instructions on importing packages and preparing Koji to run builds, see
<a class="reference internal" href="server_bootstrap.html"><span class="doc">Server Bootstrap</span></a>.</p>
<p>For instructions on using External Repos and preparing Koji to run builds, see
<a class="reference internal" href="external_repo_server_bootstrap.html"><span class="doc">External Repo Server Bootstrap</span></a>.</p>
<p>Useful scripts and config files for setting up a Koji instance are available
<a class="reference external" href="http://fedora.danny.cz/koji/">here</a>.</p>
<p>More active repo with Ansible playbooks are available at <a class="reference external" href="https://github.com/ktdreyer/koji-playbooks">koji-playbooks</a>.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Operations Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="server_bootstrap.html" class="btn btn-neutral float-right" title="Koji Server Bootstrap" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Mike McLean, Mike B, Dennis Gilmore, Mathieu Bridon, Ian McLeod, Ralph Bean, Adam Miller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>