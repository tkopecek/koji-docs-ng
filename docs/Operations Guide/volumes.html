<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Storage Volumes &mdash; Koji alpha documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="External Repository Server Bootstrap" href="external_repo_server_bootstrap.html" />
    <link rel="prev" title="Koji Server Bootstrap" href="server_bootstrap.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Koji
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Operations Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="server_howto.html">Server Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="server_bootstrap.html">Koji Server Bootstrap</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Storage Volumes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constructing-the-path">Constructing the path</a></li>
<li class="toctree-l3"><a class="reference internal" href="#symlinks-on-default-volume">Symlinks on default volume</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-new-volume">Adding a new volume</a></li>
<li class="toctree-l3"><a class="reference internal" href="#moving-builds-onto-other-volumes">Moving builds onto other volumes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-volume-in-policy-checks">Using the volume in policy checks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-a-volume-policy">Setting a volume policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cli-commands">CLI commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-calls">API calls</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="external_repo_server_bootstrap.html">External Repository Server Bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="kerberos_gssapi_debug.html">Koji Kerberos/GSSAPI debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="kojid_conf.html">Builder Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="hub_conf.html">Hub Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="database_howto.html">Database Performance Howto</a></li>
<li class="toctree-l2"><a class="reference internal" href="image_build.html">Building Images in Koji</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html">Koji Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">Tasks Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="containers.html">Running Koji in Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="supported_platforms.html">Supported Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases.html">Releases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Administration%20Guide/index.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../User%20Guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developer%20Guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../runs_here.html">Runs Here</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Koji</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Operations Guide</a> &raquo;</li>
      <li>Storage Volumes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Operations Guide/volumes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="storage-volumes">
<h1>Storage Volumes<a class="headerlink" href="#storage-volumes" title="Permalink to this headline"></a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p>Since version 1.7.0, Koji has had the ability to store builds on
multiple volumes.</p>
<p>Each build in Koji has a volume field that indicates which volume it is
stored on. The default volume is named <code class="docutils literal notranslate"><span class="pre">DEFAULT</span></code> and corresponds to the
original paths under <code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code> that predate this feature.</p>
<p>Additional volumes correspond to paths under
<code class="docutils literal notranslate"><span class="pre">/mnt/koji/vol/NAME</span></code> (where NAME is the name of the volume). All builds
associated with such a volume will be stored under this directory.
The expectation is that this directory will map to a different file system.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<div class="line-block">
<div class="line">If <code class="docutils literal notranslate"><span class="pre">koji-1.13.0-1</span></code> is on the DEFAULT volume, its path will be:</div>
<div class="line">/mnt/koji/packages/koji/1.13.0/1</div>
</div>
<div class="line-block">
<div class="line">If <code class="docutils literal notranslate"><span class="pre">koji-1.13.0-1</span></code> is on the volume named “test”, its path will be:</div>
<div class="line">/mnt/koji/vol/test/packages/koji/1.13.0/1</div>
</div>
</div>
</div>
<div class="section" id="constructing-the-path">
<h2>Constructing the path<a class="headerlink" href="#constructing-the-path" title="Permalink to this headline"></a></h2>
<p>If you are using the Koji python api, things should <strong>just work</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">koji</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mykoji</span> <span class="o">=</span> <span class="n">koji</span><span class="o">.</span><span class="n">get_profile_module</span><span class="p">(</span><span class="s1">&#39;mykoji&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">opts</span> <span class="o">=</span> <span class="n">mykoji</span><span class="o">.</span><span class="n">grab_session_options</span><span class="p">(</span><span class="n">mykoji</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="n">mykoji</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">mykoji</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">binfo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">getBuild</span><span class="p">(</span><span class="s1">&#39;test-1-1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">binfo</span><span class="p">[</span><span class="s1">&#39;volume_name&#39;</span><span class="p">]</span>
<span class="go">&#39;DEFAULT&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mykoji</span><span class="o">.</span><span class="n">pathinfo</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">binfo</span><span class="p">)</span>
<span class="go">&#39;/mnt/koji/packages/test/1/1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">binfo</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">getBuild</span><span class="p">(</span><span class="s1">&#39;fake-1.0-21&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">binfo</span><span class="p">[</span><span class="s1">&#39;volume_name&#39;</span><span class="p">]</span>
<span class="go">&#39;vol3&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mykoji</span><span class="o">.</span><span class="n">pathinfo</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">binfo</span><span class="p">)</span>
<span class="go">&#39;/mnt/koji/vol/vol3/packages/fake/1.0/21&#39;</span>
</pre></div>
</div>
<p>If you are constructing these paths yourself, then you may need to do
a little work.</p>
<blockquote>
<div><ul class="simple">
<li><p>Look for volume information in build data. Hub calls that return build
data include <code class="docutils literal notranslate"><span class="pre">volume_name</span></code> and <code class="docutils literal notranslate"><span class="pre">volume_id</span></code> fields in their return.</p></li>
<li><p>If the volume is <code class="docutils literal notranslate"><span class="pre">DEFAULT</span></code>, then the path is the “normal” path.</p></li>
<li><p>Otherwise, you need to insert <code class="docutils literal notranslate"><span class="pre">/vol/&lt;volume_name&gt;</span></code> after the
top directory (normally /mnt/koji).</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="symlinks-on-default-volume">
<h2>Symlinks on default volume<a class="headerlink" href="#symlinks-on-default-volume" title="Permalink to this headline"></a></h2>
<p>For backwards compatibility, Koji maintains symlinks on the default volume
for builds on other volumes.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>file /mnt/koji/packages/fake/1.0/21
<span class="go">/mnt/koji/packages/fake/1.0/21: symbolic link to ../../../vol/vol3/packages/fake/1.0/21</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-a-new-volume">
<h2>Adding a new volume<a class="headerlink" href="#adding-a-new-volume" title="Permalink to this headline"></a></h2>
<p>The new volume directory should initially contain a packages/
subdirectory, and the permissions should be the same as the default
packages directory.</p>
<p>Assuming you do use a mount for a vol/NAME directory, you will want to
ensure that the same mounts are created on all systems that interface with
<code class="docutils literal notranslate"><span class="pre">/mnt/koji</span></code>,  such as builders that run createrepo tasks, hosts running
kojira or similar maintenance, and any hosts that rely on the topdir option
rather than the topurl option.</p>
<p>Once you have the directory set up, you can tell Koji about it by
running <code class="docutils literal notranslate"><span class="pre">koji</span> <span class="pre">add-volume</span> <span class="pre">NAME</span></code>. This call will fail if the hub can’t find
the directory.</p>
</div>
<div class="section" id="moving-builds-onto-other-volumes">
<h2>Moving builds onto other volumes<a class="headerlink" href="#moving-builds-onto-other-volumes" title="Permalink to this headline"></a></h2>
<p>By default, all builds live on the DEFAULT volume.</p>
<p>An admin can move a build to a different volume by using the
<code class="docutils literal notranslate"><span class="pre">koji</span> <span class="pre">set-build-volume</span></code> command, or by using the underlying
<code class="docutils literal notranslate"><span class="pre">changeBuildVolume</span></code> api call.</p>
<p>Moving a build across volumes will cause kojira to trigger repo
regenerations, if appropriate. When the new volume is not DEFAULT, Koji will
create a relative symlink to the new build directory on the default
volume. Moving builds across volumes may immediately break repos (until
the regen occurs), so use caution.</p>
<p>Consider the following example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>mypkg-1.1-20 initially on default volume
<span class="gp">$ </span>file /mnt/koji/packages/mypkg/1.1/20
<span class="go">/mnt/koji/packages/mypkg/1.1/20: directory</span>

<span class="gp"># </span>move it to <span class="nb">test</span> volume
<span class="gp">$ </span>koji set-build-volume <span class="nb">test</span> mypkg-1.1-20
<span class="gp">$ </span>file /mnt/koji/vol/test/packages/mypkg/1.1/20
<span class="go">/mnt/koji/vol/test/packages/mypkg/1.1/20: directory</span>

<span class="gp"># </span>original location is now a symlink
<span class="gp">$ </span>file /mnt/koji/packages/mypkg/1.1/20
<span class="go">/mnt/koji/packages/mypkg/1.1/20: symbolic link to ../../../vol/test/packages/mypkg/1.1/20</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-volume-in-policy-checks">
<h2>Using the volume in policy checks<a class="headerlink" href="#using-the-volume-in-policy-checks" title="Permalink to this headline"></a></h2>
<p>Policies involving builds (e.g. gc policy, tag policy), can test a
build’s volume with the <code class="docutils literal notranslate"><span class="pre">volume</span></code> test. This is a pattern match
test against the volume name.</p>
</div>
<div class="section" id="setting-a-volume-policy">
<h2>Setting a volume policy<a class="headerlink" href="#setting-a-volume-policy" title="Permalink to this headline"></a></h2>
<p>The Koji 1.14.0 release adds the ability to set a volume policy on the hub.
This policy is used at import time to determine which volume the build should
be assigned to. This provides a systematic way to distribute builds
across multiple volumes without manual intervention.</p>
<p>There is relatively limited data available to the volume policy. Tests that are
expected to work include:</p>
<ul class="simple">
<li><p>user based tests (the user performing the build or running the import)</p></li>
<li><p>package based tests (e.g. <code class="docutils literal notranslate"><span class="pre">is_new_package</span></code> or <code class="docutils literal notranslate"><span class="pre">package</span></code>)</p></li>
<li><p>cg match tests</p></li>
<li><p>the buildtag test</p></li>
</ul>
<p>The action value for the volume policy should be simply the name of the volume
to use.</p>
<p>The default volume policy is <code class="docutils literal notranslate"><span class="pre">all</span> <span class="pre">::</span> <span class="pre">DEFAULT</span></code>.</p>
<p>If the volume policy contains errors, or does not return a result, then the
DEFAULT volume is used.</p>
<p>For more information about Koji policies see:
<a class="reference internal" href="../Administration%20Guide/defining_hub_policies.html"><span class="doc">Defining hub policies</span></a></p>
</div>
<div class="section" id="cli-commands">
<h2>CLI commands<a class="headerlink" href="#cli-commands" title="Permalink to this headline"></a></h2>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">add-volume</span></code></dt><dd><p>adds a new volume (directory must already be set up)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">list-volumes</span></code></dt><dd><p>prints a list of known volumes</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">set-build-volume</span></code></dt><dd><p>moves a build to different volume</p>
</dd>
</dl>
</div>
<div class="section" id="api-calls">
<h2>API calls<a class="headerlink" href="#api-calls" title="Permalink to this headline"></a></h2>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">addVolume(name,</span> <span class="pre">strict=True)</span></code></dt><dd><p>Add a new storage volume in the database</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">applyVolumePolicy(build,</span> <span class="pre">strict=False)</span></code></dt><dd><p>Apply the volume policy to a given build</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">changeBuildVolume(build,</span> <span class="pre">volume,</span> <span class="pre">strict=True)</span></code></dt><dd><p>Move a build to a different storage volume</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">getVolume(volume,</span> <span class="pre">strict=False)</span></code></dt><dd><p>Lookup the given volume</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">listVolumes()</span></code></dt><dd><p>List storage volumes</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">removeVolume(volume)</span></code></dt><dd><p>Remove unused storage volume from the database</p>
</dd>
</dl>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="server_bootstrap.html" class="btn btn-neutral float-left" title="Koji Server Bootstrap" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="external_repo_server_bootstrap.html" class="btn btn-neutral float-right" title="External Repository Server Bootstrap" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Mike McLean, Mike B, Dennis Gilmore, Mathieu Bridon, Ian McLeod, Ralph Bean, Adam Miller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>