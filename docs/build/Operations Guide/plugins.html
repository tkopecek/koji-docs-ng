<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plugins &mdash; Koji alpha documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Koji Utilities" href="utils.html" />
    <link rel="prev" title="Building Images in Koji" href="image_build.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Koji
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Operations Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="server_howto.html">Server Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="server_bootstrap.html">Koji Server Bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="volumes.html">Storage Volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="external_repo_server_bootstrap.html">External Repository Server Bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="kerberos_gssapi_debug.html">Koji Kerberos/GSSAPI debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="kojid_conf.html">Builder Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="hub_conf.html">Hub Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="database_howto.html">Database Performance Howto</a></li>
<li class="toctree-l2"><a class="reference internal" href="image_build.html">Building Images in Koji</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#runroot">Runroot</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#builder">Builder</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hub">Hub</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cli">CLI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#save-failed-tree">Save Failed Tree</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#todo">TODO</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sidetag">Sidetag</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Hub</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">CLI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#proton-messaging">Proton messaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#image-builds-using-kiwi">Image builds using Kiwi</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="utils.html">Koji Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">Tasks Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="containers.html">Running Koji in Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="supported_platforms.html">Supported Platforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="releases.html">Releases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Administration Guide/index.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../User Guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developer Guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../runs_here.html">Runs Here</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Koji</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Operations Guide</a> &raquo;</li>
      <li>Plugins</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Operations Guide/plugins.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="plugins">
<h1>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h1>
<p>Following plugins are available in default koji installation.</p>
<div class="section" id="runroot">
<h2>Runroot<a class="headerlink" href="#runroot" title="Permalink to this headline">¶</a></h2>
<p>Plugin for running any command in buildroot. It has three parts as most of the
others (hub, builder and CLI).</p>
<div class="section" id="builder">
<h3>Builder<a class="headerlink" href="#builder" title="Permalink to this headline">¶</a></h3>
<p>You enable plugin by editing <code class="docutils literal notranslate"><span class="pre">/etc/kojid.conf</span></code> by adding <code class="docutils literal notranslate"><span class="pre">plugin</span> <span class="pre">=</span> <span class="pre">runroot</span></code>
there. Plugin itself has separate configuration file on each builder located at
<code class="docutils literal notranslate"><span class="pre">/etc/kojid/plugins/runroot.conf</span></code> There is a sample configuration file
with option descriptions installed.</p>
</div>
<div class="section" id="hub">
<h3>Hub<a class="headerlink" href="#hub" title="Permalink to this headline">¶</a></h3>
<p>On the hub side <code class="docutils literal notranslate"><span class="pre">Plugins</span> <span class="pre">=</span> <span class="pre">runroot_hub</span></code> needs to be added to
<code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/hub.conf</span></code>. Note, that by default policy runroot tasks are
assigned to <code class="docutils literal notranslate"><span class="pre">runroot</span></code> channel. As this is a plugin, we don’t create it
automatically. There are three options - create channel when adding first
builder there via <code class="docutils literal notranslate"><span class="pre">koji</span> <span class="pre">add-host-to-channel</span> <span class="pre">--new</span> <span class="pre">hostname</span> <span class="pre">runroot</span></code> or by
changing the default channel policy according to <a class="reference internal" href="../Administration Guide/defining_hub_policies.html"><span class="doc">Defining Hub Policies</span></a>. Last option is to use <code class="docutils literal notranslate"><span class="pre">--channel-override</span></code>
option in CLI to drive task to channel of choice.</p>
</div>
<div class="section" id="cli">
<h3>CLI<a class="headerlink" href="#cli" title="Permalink to this headline">¶</a></h3>
<p>CLI is looking for available plugins every run, so it if it is installed, you’ll
see new command <code class="docutils literal notranslate"><span class="pre">runroot</span></code> with options described in its help. No config
options are needed to enable it.</p>
</div>
</div>
<div class="section" id="save-failed-tree">
<h2>Save Failed Tree<a class="headerlink" href="#save-failed-tree" title="Permalink to this headline">¶</a></h2>
<p>In some cases developers want to investigate exact environment in which their
build failed. Reconstructing this environment via mock needn’t end with
exactly same structure (due to builder settings, etc.). In such case this
plugin can be used to retrieve tarball with complete mock tree.</p>
<p>Additional feature is that some paths from buildroot can be left out from
tarball. Feature can be configured via
<cite>/etc/kojid/plugins/save_failed_tree.conf</cite> file. Currently only field
filters.paths is used and it consists of globs (standard python’s fnmatch is
used) separated by whitespaces.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[filters]</span>
<span class="na">paths</span> <span class="o">=</span> <span class="s">/etc/*.keytab /tmp/secret_data</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For security reasons, currently all <code class="docutils literal notranslate"><span class="pre">/tmp/krb5cc*</span></code> and <code class="docutils literal notranslate"><span class="pre">/etc/*.keytab</span></code>
files are removed from tarball. If we found some other dangerous pieces,
they can be added to this blacklist.</p>
</div>
<p>Special task method is created for achieving this which is called
<code class="docutils literal notranslate"><span class="pre">SaveFailedTree</span></code>. This task can be created via CLI:
<code class="docutils literal notranslate"><span class="pre">koji</span> <span class="pre">save-failed-tree</span> <span class="pre">&lt;taskID&gt;</span></code>. Additional options are:</p>
<dl class="option">
<dt id="cmdoption-full">
<code class="sig-name descname">--full</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-full" title="Permalink to this definition">¶</a></dt>
<dd><p>directs koji to create tarball with complete tree.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-nowait">
<code class="sig-name descname">--nowait</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-nowait" title="Permalink to this definition">¶</a></dt>
<dd><p>exit immediately after creating task</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-quiet">
<code class="sig-name descname">--quiet</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-quiet" title="Permalink to this definition">¶</a></dt>
<dd><p>don’t print any information to output</p>
</dd></dl>

<p>After task finishes, one can find the tarball on relevant task web page (URL
will be printed to stdout until <code class="docutils literal notranslate"><span class="pre">--quiet</span></code> is used.</p>
<p>Plugin allow to save trees only for tasks defined in config
<code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/plugins/save_failed_tree.conf</span></code>. Option
<code class="docutils literal notranslate"><span class="pre">allowed_methods</span></code> contains list of comma-delimited names of tasks. Default
configuration contains line: <code class="docutils literal notranslate"><span class="pre">allowed_methods</span> <span class="pre">=</span> <span class="pre">buildArch</span></code>. Anybody
is allowed to create this type of task (and download tarball).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Don’t forget that this type of task can generate huge amount of data, so use
it wisely.</p>
</div>
<div class="section" id="todo">
<h3>TODO<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>Separate volume/directory on hub</p></li>
<li><p>garbage collector + policy for retaining generated tarballs</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="sidetag">
<h2>Sidetag<a class="headerlink" href="#sidetag" title="Permalink to this headline">¶</a></h2>
<p>Sidetag plugin is originally work of Mikolaj Izdebski and was pulled into base
koji due to easier integration with rest of the code.</p>
<p>It is used for managing <cite>sidetags</cite> which are light-weight short-lived build tags
for developer’s use. Sidetag creation is governed by hub’s policy.</p>
<div class="section" id="id1">
<h3>Hub<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Example for <cite>/etc/koji-hub/hub.conf</cite>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">PluginPath</span> <span class="o">=</span> <span class="s">/usr/lib/koji-hub-plugins</span>
<span class="na">Plugins</span> <span class="o">=</span> <span class="s">sidetag_hub</span>

<span class="k">[policy]</span>
<span class="na">sidetag</span> <span class="o">=</span><span class="s"></span>
<span class="s">    # allow maximum of 10 sidetags per user for f30-build tag</span>
<span class="s">    tag f30-build &amp;&amp; compare number_of_tags &lt;= 10 :: allow</span>
<span class="s">    # forbid everything else</span>
<span class="s">    all :: deny</span>

<span class="na">package_list</span> <span class="o">=</span><span class="s"></span>
<span class="s">    # allow blocking for owners in their sidetags</span>
<span class="s">    match action block &amp;&amp; is_sidetag_owner :: allow</span>
<span class="s">    all :: deny</span>
</pre></div>
</div>
<p>There are two special policy tests <cite>is_sidetag</cite> and <cite>is_sidetag_owner</cite> with
expectable behaviour.</p>
<p>Now Sidetag Koji plugin should be installed.  To verify that, run
<cite>koji list-api</cite> command – it should now display <cite>createSideTag</cite>
as one of available API calls.</p>
<p>Plugin has also its own configuration file
<code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/plugins/sidetag.conf</span></code> which contains following options:</p>
<dl class="glossary simple">
<dt id="term-remove-empty-off">remove_empty = off</dt><dd><p>If this is set, sidetag is automatically deleted when
last package is untagged from there.</p>
</dd>
<dt id="term-allowed-suffixes">allowed_suffixes =</dt><dd><p>List of strings delimited by commas. These suffixes are then allowed to
be requested via <code class="docutils literal notranslate"><span class="pre">createSideTag</span></code></p>
</dd>
<dt id="term-name-template-basetag-s-side-tag-id-d">name_template = {basetag}s-side-{tag_id}d</dt><dd><p>Python string template to be used for generation of sidetag name. It needs
to contain both basetag/tag_id placeholders.</p>
</dd>
</dl>
</div>
<div class="section" id="id2">
<h3>CLI<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>For convenient handling, also CLI part is provided. Typical session would look
like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ koji add-sidetag f30-build --wait
f30-build-side-123456
Successfully waited <span class="m">1</span>:36 <span class="k">for</span> a new f30-build-side-123456 repo

$ koji remove-sidetag f30-build-side-123456
</pre></div>
</div>
</div>
<div class="section" id="api">
<h3>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h3>
<p>And in scripts, you can use following calls:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">koji</span>
<span class="n">ks</span> <span class="o">=</span> <span class="n">koji</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="s1">&#39;https://koji.fedoraproject.org/kojihub&#39;</span><span class="p">)</span>
<span class="n">ks</span><span class="o">.</span><span class="n">gssapi_login</span><span class="p">()</span>
<span class="n">ks</span><span class="o">.</span><span class="n">createSideTag</span><span class="p">(</span><span class="s1">&#39;f30-build&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="proton-messaging">
<span id="protonmsg-config"></span><h2>Proton messaging<a class="headerlink" href="#proton-messaging" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">protonmsg</span></code> plugin for the hub will, if enabled, send a wide range of
messages about Koji activity to the configured amqps message brokers.
Most callback events on the hub are translated into messages.</p>
<p>In order to enable this plugin, you must:</p>
<ul class="simple">
<li><p>add <code class="docutils literal notranslate"><span class="pre">protonmsg</span></code> to the <code class="docutils literal notranslate"><span class="pre">Plugins</span></code> setting in <code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/hub.conf</span></code></p></li>
<li><p>provide a configuration file for the plugin at
<code class="docutils literal notranslate"><span class="pre">/etc/koji-hub/plugins/protonmsg.conf</span></code></p></li>
</ul>
<p>The configuration file is ini-style format with three sections: broker,
queue and message.
The <code class="docutils literal notranslate"><span class="pre">[broker]</span></code> section defines how the plugin connects to the message bus.
The following fields are understood:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">urls</span></code> – a space separated list of amqps urls. Additional urls are
treated as fallbacks. The plugin will send to the first one that accepts
the message</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cert</span></code> – the combined client cert and key file for authenticating koji to
the broker.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cacert</span></code> – the CA certificate to verify the broker server TLS connection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">topic_prefix</span></code> – this string will be used as a prefix for all message topics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">connect_timeout</span></code> – the number of seconds to wait for a connection before
timing out</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">send_timeout</span></code> – the number of seconds to wait while sending a message
before timing out</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">[message]</span></code> section sets parameters for how messages are formed.
Currently only one field is understood:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">extra_limit</span></code> – the maximum allowed size for <code class="docutils literal notranslate"><span class="pre">build.extra</span></code> fields that
appear in messages. If the <code class="docutils literal notranslate"><span class="pre">build.extra</span></code> field is longer (in terms of
json-encoded length), then it will be omitted. The default value is <code class="docutils literal notranslate"><span class="pre">0</span></code>
which means no limit.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">[queue]</span></code> section controls how (or if) the plugin will use the database
to queue messages when they cannot be immediately sent.
The following fields are understood:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">enabled</span></code> – if true, then the feature is enabled</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_size</span></code> – the maximum number of queued messages to send at one time</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_age</span></code> – the age (in hours) at which old messages in the queue are discarded</p></li>
</ul>
<p>It is important to note that the database queue is only a fallback mechanism.
The plugin will always attempt to send messages as they are issued.
Messages are only placed in the database queue when they cannot be immediately
sent on the bus (e.g. if the amqps server is offline).</p>
<p>Admins should consider the balance between the <code class="docutils literal notranslate"><span class="pre">batch_size</span></code> and
<code class="docutils literal notranslate"><span class="pre">extra_limit</span></code> options, as both can affect the total amount of data that the
plugin could attempt to send during a single call.</p>
</div>
<div class="section" id="image-builds-using-kiwi">
<span id="kiwi-build"></span><h2>Image builds using Kiwi<a class="headerlink" href="#image-builds-using-kiwi" title="Permalink to this headline">¶</a></h2>
<p><strong>This is just a tech-preview. API/usage can drastically change in upcoming
releases</strong></p>
<p>Plugin for creating images via <a class="reference external" href="https://osinside.github.io/kiwi/">kiwi</a>
project. Minimal supported version of kiwi is <code class="docutils literal notranslate"><span class="pre">kiwi-9.24.2</span></code>.</p>
<p>All three parts (cli/hub/builder) needs to be installed. There is currently no
configuration except allowing the plugins (name is ‘kiwi’ for all components).</p>
<p>Builders have to be part of <code class="docutils literal notranslate"><span class="pre">image</span></code> channel and don’t need to have any
specific library installed (kiwi invocation/usage is only in buildroots not on
builder itself). (Temporarily <code class="docutils literal notranslate"><span class="pre">python3-kiwi</span></code> needs to be installed on builder
for kojid to be able to parse kiwi output. It will be changed to json in next
version and this requirement will be dropped.)</p>
<p>Buildtag needs to be configured by adding special group <code class="docutils literal notranslate"><span class="pre">kiwi</span></code> which should
contain at least <code class="docutils literal notranslate"><span class="pre">kiwi-cli</span></code>, potentially <code class="docutils literal notranslate"><span class="pre">jing</span></code> for better description files
validation and any <code class="docutils literal notranslate"><span class="pre">kiwi-systemdeps-*</span></code> packages for requested image types. So,
most simple configuration will look like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ koji add-group kiwi-build-tag kiwi
$ koji add-group-pkg kiwi-build-tag kiwi kiwi-cli
</pre></div>
</div>
<p>Another thing we need to ensure is that we’re building in chroot and not in
container.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ koji edit-tag kiwi-build-tag -x mock.new_chroot<span class="o">=</span>False
</pre></div>
</div>
<p>Calling the build itself is a matter of simple CLI call:</p>
<p>Selecting other than default kiwi profile can be done by <code class="docutils literal notranslate"><span class="pre">--kiwi-profile</span></code>
option. Similarly to other image tasks, alternative architecture failures can be
ignored for successful build by <code class="docutils literal notranslate"><span class="pre">--can-fail</span></code> option. <code class="docutils literal notranslate"><span class="pre">--arch</span></code> can be used to
limit build tag architectures.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="image_build.html" class="btn btn-neutral float-left" title="Building Images in Koji" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="utils.html" class="btn btn-neutral float-right" title="Koji Utilities" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Mike McLean, Mike B, Dennis Gilmore, Mathieu Bridon, Ian McLeod, Ralph Bean, Adam Miller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>